var e=()=>void 0,t={NODE_CLIENT:!1,NODE_ADMIN:!1,SDK_VERSION:"${JSCORE_VERSION}"},n=function(e,t){if(!e)throw r(t)},r=function(e){return Error(`Firebase Database (`+t.SDK_VERSION+`) INTERNAL ASSERT FAILED: `+e)},i=function(e){let t=[],n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=i&63|128):(i&64512)==55296&&r+1<e.length&&(e.charCodeAt(r+1)&64512)==56320?(i=65536+((i&1023)<<10)+(e.charCodeAt(++r)&1023),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=i&63|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=i&63|128)}return t},a=function(e){let t=[],n=0,r=0;for(;n<e.length;){let i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){let a=e[n++];t[r++]=String.fromCharCode((i&31)<<6|a&63)}else if(i>239&&i<365){let a=e[n++],o=e[n++],s=e[n++],c=((i&7)<<18|(a&63)<<12|(o&63)<<6|s&63)-65536;t[r++]=String.fromCharCode(55296+(c>>10)),t[r++]=String.fromCharCode(56320+(c&1023))}else{let a=e[n++],o=e[n++];t[r++]=String.fromCharCode((i&15)<<12|(a&63)<<6|o&63)}}return t.join(``)},o={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`,get ENCODED_VALS(){return this.ENCODED_VALS_BASE+`+/=`},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+`-_.`},HAS_NATIVE_SUPPORT:typeof atob==`function`,encodeByteArray(e,t){if(!Array.isArray(e))throw Error(`encodeByteArray takes an array as a parameter`);this.init_();let n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let t=0;t<e.length;t+=3){let i=e[t],a=t+1<e.length,o=a?e[t+1]:0,s=t+2<e.length,c=s?e[t+2]:0,l=i>>2,u=(i&3)<<4|o>>4,d=(o&15)<<2|c>>6,f=c&63;s||(f=64,a||(d=64)),r.push(n[l],n[u],n[d],n[f])}return r.join(``)},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(i(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):a(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();let n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let t=0;t<e.length;){let i=n[e.charAt(t++)],a=t<e.length?n[e.charAt(t)]:0;++t;let o=t<e.length?n[e.charAt(t)]:64;++t;let c=t<e.length?n[e.charAt(t)]:64;if(++t,i==null||a==null||o==null||c==null)throw new s;let l=i<<2|a>>4;if(r.push(l),o!==64){let e=a<<4&240|o>>2;if(r.push(e),c!==64){let e=o<<6&192|c;r.push(e)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},s=class extends Error{constructor(){super(...arguments),this.name=`DecodeBase64StringError`}},c=function(e){let t=i(e);return o.encodeByteArray(t,!0)},l=function(e){return c(e).replace(/\./g,``)},u=function(e){try{return o.decodeString(e,!0)}catch(e){console.error(`base64Decode failed: `,e)}return null};function d(e){return f(void 0,e)}function f(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:let n=t;return new Date(n.getTime());case Object:e===void 0&&(e={});break;case Array:e=[];break;default:return t}for(let n in t)!t.hasOwnProperty(n)||!p(n)||(e[n]=f(e[n],t[n]));return e}function p(e){return e!==`__proto__`}function ee(){if(typeof self<`u`)return self;if(typeof window<`u`)return window;if(typeof global<`u`)return global;throw Error(`Unable to locate global object.`)}var te=()=>ee().__FIREBASE_DEFAULTS__,ne=()=>{if(typeof process>`u`)return;let e={}.__FIREBASE_DEFAULTS__;if(e)return JSON.parse(e)},re=()=>{if(typeof document>`u`)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}let t=e&&u(e[1]);return t&&JSON.parse(t)},ie=()=>{try{return e()||te()||ne()||re()}catch(e){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`);return}},ae=e=>ie()?.emulatorHosts?.[e],oe=e=>{let t=ae(e);if(!t)return;let n=t.lastIndexOf(`:`);if(n<=0||n+1===t.length)throw Error(`Invalid host ${t} with no separate hostname and port!`);let r=parseInt(t.substring(n+1),10);return t[0]===`[`?[t.substring(1,n-1),r]:[t.substring(0,n),r]},se=()=>ie()?.config,ce=class{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),typeof e==`function`&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,n))}}};function le(e){try{return(e.startsWith(`http://`)||e.startsWith(`https://`)?new URL(e).hostname:e).endsWith(`.cloudworkstations.dev`)}catch{return!1}}async function ue(e){return(await fetch(e,{credentials:`include`})).ok}function de(e,t){if(e.uid)throw Error(`The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.`);let n={alg:`none`,type:`JWT`},r=t||`demo-project`,i=e.iat||0,a=e.sub||e.user_id;if(!a)throw Error(`mockUserToken must contain 'sub' or 'user_id' field!`);let o={iss:`https://securetoken.google.com/${r}`,aud:r,iat:i,exp:i+3600,auth_time:i,sub:a,user_id:a,firebase:{sign_in_provider:`custom`,identities:{}},...e};return[l(JSON.stringify(n)),l(JSON.stringify(o)),``].join(`.`)}var fe={};function pe(){let e={prod:[],emulator:[]};for(let t of Object.keys(fe))fe[t]?e.emulator.push(t):e.prod.push(t);return e}function me(e){let t=document.getElementById(e),n=!1;return t||(t=document.createElement(`div`),t.setAttribute(`id`,e),n=!0),{created:n,element:t}}var he=!1;function ge(e,t){if(typeof window>`u`||typeof document>`u`||!le(window.location.host)||fe[e]===t||fe[e]||he)return;fe[e]=t;function n(e){return`__firebase__banner__${e}`}let r=`__firebase__banner`,i=pe().prod.length>0;function a(){let e=document.getElementById(r);e&&e.remove()}function o(e){e.style.display=`flex`,e.style.background=`#7faaf0`,e.style.position=`fixed`,e.style.bottom=`5px`,e.style.left=`5px`,e.style.padding=`.5em`,e.style.borderRadius=`5px`,e.style.alignItems=`center`}function s(e,t){e.setAttribute(`width`,`24`),e.setAttribute(`id`,t),e.setAttribute(`height`,`24`),e.setAttribute(`viewBox`,`0 0 24 24`),e.setAttribute(`fill`,`none`),e.style.marginLeft=`-6px`}function c(){let e=document.createElement(`span`);return e.style.cursor=`pointer`,e.style.marginLeft=`16px`,e.style.fontSize=`24px`,e.innerHTML=` &times;`,e.onclick=()=>{he=!0,a()},e}function l(e,t){e.setAttribute(`id`,t),e.innerText=`Learn more`,e.href=`https://firebase.google.com/docs/studio/preview-apps#preview-backend`,e.setAttribute(`target`,`__blank`),e.style.paddingLeft=`5px`,e.style.textDecoration=`underline`}function u(){let e=me(r),t=n(`text`),a=document.getElementById(t)||document.createElement(`span`),u=n(`learnmore`),d=document.getElementById(u)||document.createElement(`a`),f=n(`preprendIcon`),p=document.getElementById(f)||document.createElementNS(`http://www.w3.org/2000/svg`,`svg`);if(e.created){let t=e.element;o(t),l(d,u);let n=c();s(p,f),t.append(p,a,d,n),document.body.appendChild(t)}i?(a.innerText=`Preview backend disconnected.`,p.innerHTML=`<g clip-path="url(#clip0_6013_33858)">
<path d="M4.8 17.6L12 5.6L19.2 17.6H4.8ZM6.91667 16.4H17.0833L12 7.93333L6.91667 16.4ZM12 15.6C12.1667 15.6 12.3056 15.5444 12.4167 15.4333C12.5389 15.3111 12.6 15.1667 12.6 15C12.6 14.8333 12.5389 14.6944 12.4167 14.5833C12.3056 14.4611 12.1667 14.4 12 14.4C11.8333 14.4 11.6889 14.4611 11.5667 14.5833C11.4556 14.6944 11.4 14.8333 11.4 15C11.4 15.1667 11.4556 15.3111 11.5667 15.4333C11.6889 15.5444 11.8333 15.6 12 15.6ZM11.4 13.6H12.6V10.4H11.4V13.6Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6013_33858">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`):(p.innerHTML=`<g clip-path="url(#clip0_6083_34804)">
<path d="M11.4 15.2H12.6V11.2H11.4V15.2ZM12 10C12.1667 10 12.3056 9.94444 12.4167 9.83333C12.5389 9.71111 12.6 9.56667 12.6 9.4C12.6 9.23333 12.5389 9.09444 12.4167 8.98333C12.3056 8.86111 12.1667 8.8 12 8.8C11.8333 8.8 11.6889 8.86111 11.5667 8.98333C11.4556 9.09444 11.4 9.23333 11.4 9.4C11.4 9.56667 11.4556 9.71111 11.5667 9.83333C11.6889 9.94444 11.8333 10 12 10ZM12 18.4C11.1222 18.4 10.2944 18.2333 9.51667 17.9C8.73889 17.5667 8.05556 17.1111 7.46667 16.5333C6.88889 15.9444 6.43333 15.2611 6.1 14.4833C5.76667 13.7056 5.6 12.8778 5.6 12C5.6 11.1111 5.76667 10.2833 6.1 9.51667C6.43333 8.73889 6.88889 8.06111 7.46667 7.48333C8.05556 6.89444 8.73889 6.43333 9.51667 6.1C10.2944 5.76667 11.1222 5.6 12 5.6C12.8889 5.6 13.7167 5.76667 14.4833 6.1C15.2611 6.43333 15.9389 6.89444 16.5167 7.48333C17.1056 8.06111 17.5667 8.73889 17.9 9.51667C18.2333 10.2833 18.4 11.1111 18.4 12C18.4 12.8778 18.2333 13.7056 17.9 14.4833C17.5667 15.2611 17.1056 15.9444 16.5167 16.5333C15.9389 17.1111 15.2611 17.5667 14.4833 17.9C13.7167 18.2333 12.8889 18.4 12 18.4ZM12 17.2C13.4444 17.2 14.6722 16.6944 15.6833 15.6833C16.6944 14.6722 17.2 13.4444 17.2 12C17.2 10.5556 16.6944 9.32778 15.6833 8.31667C14.6722 7.30555 13.4444 6.8 12 6.8C10.5556 6.8 9.32778 7.30555 8.31667 8.31667C7.30556 9.32778 6.8 10.5556 6.8 12C6.8 13.4444 7.30556 14.6722 8.31667 15.6833C9.32778 16.6944 10.5556 17.2 12 17.2Z" fill="#212121"/>
</g>
<defs>
<clipPath id="clip0_6083_34804">
<rect width="24" height="24" fill="white"/>
</clipPath>
</defs>`,a.innerText=`Preview backend running in this workspace.`),a.setAttribute(`id`,t)}document.readyState===`loading`?window.addEventListener(`DOMContentLoaded`,u):u()}function _e(){return typeof navigator<`u`&&typeof navigator.userAgent==`string`?navigator.userAgent:``}function ve(){return typeof window<`u`&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(_e())}function ye(){return typeof navigator==`object`&&navigator.product===`ReactNative`}function m(){return t.NODE_CLIENT===!0||t.NODE_ADMIN===!0}function be(){try{return typeof indexedDB==`object`}catch{return!1}}function xe(){return new Promise((e,t)=>{try{let n=!0,r=`validate-browser-context-for-indexeddb-analytics-module`,i=self.indexedDB.open(r);i.onsuccess=()=>{i.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},i.onupgradeneeded=()=>{n=!1},i.onerror=()=>{t(i.error?.message||``)}}catch(e){t(e)}})}var Se=`FirebaseError`,Ce=class e extends Error{constructor(t,n,r){super(n),this.code=t,this.customData=r,this.name=Se,Object.setPrototypeOf(this,e.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,we.prototype.create)}},we=class{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){let n=t[0]||{},r=`${this.service}/${e}`,i=this.errors[e],a=i?Te(i,n):`Error`;return new Ce(r,`${this.serviceName}: ${a} (${r}).`,n)}};function Te(e,t){return e.replace(Ee,(e,n)=>{let r=t[n];return r==null?`<${n}?>`:String(r)})}var Ee=/\{\$([^}]+)}/g;function De(e){return JSON.parse(e)}function h(e){return JSON.stringify(e)}var Oe=function(e){let t={},n={},r={},i=``;try{let a=e.split(`.`);t=De(u(a[0])||``),n=De(u(a[1])||``),i=a[2],r=n.d||{},delete n.d}catch{}return{header:t,claims:n,data:r,signature:i}},ke=function(e){let t=Oe(e).claims;return!!t&&typeof t==`object`&&t.hasOwnProperty(`iat`)},Ae=function(e){let t=Oe(e).claims;return typeof t==`object`&&t.admin===!0};function g(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function je(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]}function Me(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function Ne(e,t,n){let r={};for(let i in e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=t.call(n,e[i],i,e));return r}function Pe(e,t){if(e===t)return!0;let n=Object.keys(e),r=Object.keys(t);for(let i of n){if(!r.includes(i))return!1;let n=e[i],a=t[i];if(Fe(n)&&Fe(a)){if(!Pe(n,a))return!1}else if(n!==a)return!1}for(let e of r)if(!n.includes(e))return!1;return!0}function Fe(e){return typeof e==`object`&&!!e}function Ie(e){let t=[];for(let[n,r]of Object.entries(e))Array.isArray(r)?r.forEach(e=>{t.push(encodeURIComponent(n)+`=`+encodeURIComponent(e))}):t.push(encodeURIComponent(n)+`=`+encodeURIComponent(r));return t.length?`&`+t.join(`&`):``}var Le=class{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=512/8,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||=0;let n=this.W_;if(typeof e==`string`)for(let r=0;r<16;r++)n[r]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let r=0;r<16;r++)n[r]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let e=16;e<80;e++){let t=n[e-3]^n[e-8]^n[e-14]^n[e-16];n[e]=(t<<1|t>>>31)&4294967295}let r=this.chain_[0],i=this.chain_[1],a=this.chain_[2],o=this.chain_[3],s=this.chain_[4],c,l;for(let e=0;e<80;e++){e<40?e<20?(c=o^i&(a^o),l=1518500249):(c=i^a^o,l=1859775393):e<60?(c=i&a|o&(i|a),l=2400959708):(c=i^a^o,l=3395469782);let t=(r<<5|r>>>27)+c+s+l+n[e]&4294967295;s=o,o=a,a=(i<<30|i>>>2)&4294967295,i=r,r=t}this.chain_[0]=this.chain_[0]+r&4294967295,this.chain_[1]=this.chain_[1]+i&4294967295,this.chain_[2]=this.chain_[2]+a&4294967295,this.chain_[3]=this.chain_[3]+o&4294967295,this.chain_[4]=this.chain_[4]+s&4294967295}update(e,t){if(e==null)return;t===void 0&&(t=e.length);let n=t-this.blockSize,r=0,i=this.buf_,a=this.inbuf_;for(;r<t;){if(a===0)for(;r<=n;)this.compress_(e,r),r+=this.blockSize;if(typeof e==`string`){for(;r<t;)if(i[a]=e.charCodeAt(r),++a,++r,a===this.blockSize){this.compress_(i),a=0;break}}else for(;r<t;)if(i[a]=e[r],++a,++r,a===this.blockSize){this.compress_(i),a=0;break}}this.inbuf_=a,this.total_+=t}digest(){let e=[],t=this.total_*8;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let e=this.blockSize-1;e>=56;e--)this.buf_[e]=t&255,t/=256;this.compress_(this.buf_);let n=0;for(let t=0;t<5;t++)for(let r=24;r>=0;r-=8)e[n]=this.chain_[t]>>r&255,++n;return e}};function Re(e,t){return`${e} failed: ${t} argument `}var ze=function(e){let t=[],r=0;for(let i=0;i<e.length;i++){let a=e.charCodeAt(i);if(a>=55296&&a<=56319){let t=a-55296;i++,n(i<e.length,`Surrogate pair missing trail surrogate.`);let r=e.charCodeAt(i)-56320;a=65536+(t<<10)+r}a<128?t[r++]=a:a<2048?(t[r++]=a>>6|192,t[r++]=a&63|128):a<65536?(t[r++]=a>>12|224,t[r++]=a>>6&63|128,t[r++]=a&63|128):(t[r++]=a>>18|240,t[r++]=a>>12&63|128,t[r++]=a>>6&63|128,t[r++]=a&63|128)}return t},Be=function(e){let t=0;for(let n=0;n<e.length;n++){let r=e.charCodeAt(n);r<128?t++:r<2048?t+=2:r>=55296&&r<=56319?(t+=4,n++):t+=3}return t};function Ve(e){return e&&e._delegate?e._delegate:e}var He=class{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode=`LAZY`,this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}},_=`[DEFAULT]`,Ue=class{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){let t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){let e=new ce;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{let n=this.getOrInitializeService({instanceIdentifier:t});n&&e.resolve(n)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){let t=this.normalizeInstanceIdentifier(e?.identifier),n=e?.optional??!1;if(this.isInitialized(t)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:t})}catch(e){if(n)return null;throw e}else if(n)return null;else throw Error(`Service ${this.name} is not available`)}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(Ge(e))try{this.getOrInitializeService({instanceIdentifier:_})}catch{}for(let[e,t]of this.instancesDeferred.entries()){let n=this.normalizeInstanceIdentifier(e);try{let e=this.getOrInitializeService({instanceIdentifier:n});t.resolve(e)}catch{}}}}clearInstance(e=_){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){let e=Array.from(this.instances.values());await Promise.all([...e.filter(e=>`INTERNAL`in e).map(e=>e.INTERNAL.delete()),...e.filter(e=>`_delete`in e).map(e=>e._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=_){return this.instances.has(e)}getOptions(e=_){return this.instancesOptions.get(e)||{}}initialize(e={}){let{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);let r=this.getOrInitializeService({instanceIdentifier:n,options:t});for(let[e,t]of this.instancesDeferred.entries())n===this.normalizeInstanceIdentifier(e)&&t.resolve(r);return r}onInit(e,t){let n=this.normalizeInstanceIdentifier(t),r=this.onInitCallbacks.get(n)??new Set;r.add(e),this.onInitCallbacks.set(n,r);let i=this.instances.get(n);return i&&e(i,n),()=>{r.delete(e)}}invokeOnInitCallbacks(e,t){let n=this.onInitCallbacks.get(t);if(n)for(let r of n)try{r(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let n=this.instances.get(e);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:We(e),options:t}),this.instances.set(e,n),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(n,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,n)}catch{}return n||null}normalizeInstanceIdentifier(e=_){return this.component?this.component.multipleInstances?e:_:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!==`EXPLICIT`}};function We(e){return e===_?void 0:e}function Ge(e){return e.instantiationMode===`EAGER`}var Ke=class{constructor(e){this.name=e,this.providers=new Map}addComponent(e){let t=this.getProvider(e.name);if(t.isComponentSet())throw Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);let t=new Ue(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}},qe=[],v;(function(e){e[e.DEBUG=0]=`DEBUG`,e[e.VERBOSE=1]=`VERBOSE`,e[e.INFO=2]=`INFO`,e[e.WARN=3]=`WARN`,e[e.ERROR=4]=`ERROR`,e[e.SILENT=5]=`SILENT`})(v||={});var Je={debug:v.DEBUG,verbose:v.VERBOSE,info:v.INFO,warn:v.WARN,error:v.ERROR,silent:v.SILENT},Ye=v.INFO,Xe={[v.DEBUG]:`log`,[v.VERBOSE]:`log`,[v.INFO]:`info`,[v.WARN]:`warn`,[v.ERROR]:`error`},Ze=(e,t,...n)=>{if(t<e.logLevel)return;let r=new Date().toISOString(),i=Xe[t];if(i)console[i](`[${r}]  ${e.name}:`,...n);else throw Error(`Attempted to log a message with an invalid logType (value: ${t})`)},Qe=class{constructor(e){this.name=e,this._logLevel=Ye,this._logHandler=Ze,this._userLogHandler=null,qe.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in v))throw TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e==`string`?Je[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!=`function`)throw TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,v.DEBUG,...e),this._logHandler(this,v.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,v.VERBOSE,...e),this._logHandler(this,v.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,v.INFO,...e),this._logHandler(this,v.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,v.WARN,...e),this._logHandler(this,v.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,v.ERROR,...e),this._logHandler(this,v.ERROR,...e)}},$e=(e,t)=>t.some(t=>e instanceof t),et,tt;function nt(){return et||=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]}function rt(){return tt||=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey]}var it=new WeakMap,at=new WeakMap,ot=new WeakMap,st=new WeakMap,ct=new WeakMap;function lt(e){let t=new Promise((t,n)=>{let r=()=>{e.removeEventListener(`success`,i),e.removeEventListener(`error`,a)},i=()=>{t(y(e.result)),r()},a=()=>{n(e.error),r()};e.addEventListener(`success`,i),e.addEventListener(`error`,a)});return t.then(t=>{t instanceof IDBCursor&&it.set(t,e)}).catch(()=>{}),ct.set(t,e),t}function ut(e){if(at.has(e))return;let t=new Promise((t,n)=>{let r=()=>{e.removeEventListener(`complete`,i),e.removeEventListener(`error`,a),e.removeEventListener(`abort`,a)},i=()=>{t(),r()},a=()=>{n(e.error||new DOMException(`AbortError`,`AbortError`)),r()};e.addEventListener(`complete`,i),e.addEventListener(`error`,a),e.addEventListener(`abort`,a)});at.set(e,t)}var dt={get(e,t,n){if(e instanceof IDBTransaction){if(t===`done`)return at.get(e);if(t===`objectStoreNames`)return e.objectStoreNames||ot.get(e);if(t===`store`)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return y(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t===`done`||t===`store`)?!0:t in e}};function ft(e){dt=e(dt)}function pt(e){return e===IDBDatabase.prototype.transaction&&!(`objectStoreNames`in IDBTransaction.prototype)?function(t,...n){let r=e.call(ht(this),t,...n);return ot.set(r,t.sort?t.sort():[t]),y(r)}:rt().includes(e)?function(...t){return e.apply(ht(this),t),y(it.get(this))}:function(...t){return y(e.apply(ht(this),t))}}function mt(e){return typeof e==`function`?pt(e):(e instanceof IDBTransaction&&ut(e),$e(e,nt())?new Proxy(e,dt):e)}function y(e){if(e instanceof IDBRequest)return lt(e);if(st.has(e))return st.get(e);let t=mt(e);return t!==e&&(st.set(e,t),ct.set(t,e)),t}var ht=e=>ct.get(e);function gt(e,t,{blocked:n,upgrade:r,blocking:i,terminated:a}={}){let o=indexedDB.open(e,t),s=y(o);return r&&o.addEventListener(`upgradeneeded`,e=>{r(y(o.result),e.oldVersion,e.newVersion,y(o.transaction),e)}),n&&o.addEventListener(`blocked`,e=>n(e.oldVersion,e.newVersion,e)),s.then(e=>{a&&e.addEventListener(`close`,()=>a()),i&&e.addEventListener(`versionchange`,e=>i(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}var _t=[`get`,`getKey`,`getAll`,`getAllKeys`,`count`],vt=[`put`,`add`,`delete`,`clear`],yt=new Map;function bt(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t==`string`))return;if(yt.get(t))return yt.get(t);let n=t.replace(/FromIndex$/,``),r=t!==n,i=vt.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(i||_t.includes(n)))return;let a=async function(e,...t){let a=this.transaction(e,i?`readwrite`:`readonly`),o=a.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),i&&a.done]))[0]};return yt.set(t,a),a}ft(e=>({...e,get:(t,n,r)=>bt(t,n)||e.get(t,n,r),has:(t,n)=>!!bt(t,n)||e.has(t,n)}));var xt=class{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(St(e)){let t=e.getImmediate();return`${t.library}/${t.version}`}else return null}).filter(e=>e).join(` `)}};function St(e){return e.getComponent()?.type===`VERSION`}var Ct=`@firebase/app`,wt=`0.14.6`,b=new Qe(`@firebase/app`),Tt=`@firebase/app-compat`,Et=`@firebase/analytics-compat`,Dt=`@firebase/analytics`,Ot=`@firebase/app-check-compat`,kt=`@firebase/app-check`,At=`@firebase/auth`,jt=`@firebase/auth-compat`,Mt=`@firebase/database`,Nt=`@firebase/data-connect`,Pt=`@firebase/database-compat`,Ft=`@firebase/functions`,It=`@firebase/functions-compat`,Lt=`@firebase/installations`,Rt=`@firebase/installations-compat`,zt=`@firebase/messaging`,Bt=`@firebase/messaging-compat`,Vt=`@firebase/performance`,Ht=`@firebase/performance-compat`,Ut=`@firebase/remote-config`,Wt=`@firebase/remote-config-compat`,Gt=`@firebase/storage`,Kt=`@firebase/storage-compat`,qt=`@firebase/firestore`,Jt=`@firebase/ai`,Yt=`@firebase/firestore-compat`,Xt=`firebase`,Zt=`12.6.0`,Qt=`[DEFAULT]`,$t={[Ct]:`fire-core`,[Tt]:`fire-core-compat`,[Dt]:`fire-analytics`,[Et]:`fire-analytics-compat`,[kt]:`fire-app-check`,[Ot]:`fire-app-check-compat`,[At]:`fire-auth`,[jt]:`fire-auth-compat`,[Mt]:`fire-rtdb`,[Nt]:`fire-data-connect`,[Pt]:`fire-rtdb-compat`,[Ft]:`fire-fn`,[It]:`fire-fn-compat`,[Lt]:`fire-iid`,[Rt]:`fire-iid-compat`,[zt]:`fire-fcm`,[Bt]:`fire-fcm-compat`,[Vt]:`fire-perf`,[Ht]:`fire-perf-compat`,[Ut]:`fire-rc`,[Wt]:`fire-rc-compat`,[Gt]:`fire-gcs`,[Kt]:`fire-gcs-compat`,[qt]:`fire-fst`,[Yt]:`fire-fst-compat`,[Jt]:`fire-vertex`,"fire-js":`fire-js`,[Xt]:`fire-js-all`},en=new Map,tn=new Map,nn=new Map;function rn(e,t){try{e.container.addComponent(t)}catch(n){b.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function an(e){let t=e.name;if(nn.has(t))return b.debug(`There were multiple attempts to register component ${t}.`),!1;nn.set(t,e);for(let t of en.values())rn(t,e);for(let t of tn.values())rn(t,e);return!0}function on(e,t){let n=e.container.getProvider(`heartbeat`).getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}function sn(e){return e==null?!1:e.settings!==void 0}var x=new we(`app`,`Firebase`,{"no-app":`No Firebase App '{$appName}' has been created - call initializeApp() first`,"bad-app-name":`Illegal App name: '{$appName}'`,"duplicate-app":`Firebase App named '{$appName}' already exists with different options or config`,"app-deleted":`Firebase App named '{$appName}' already deleted`,"server-app-deleted":`Firebase Server App has been deleted`,"no-options":`Need to provide options, when not being deployed to hosting via source.`,"invalid-app-argument":`firebase.{$appName}() takes either no argument or a Firebase App instance.`,"invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":`Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.`,"idb-get":`Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.`,"idb-set":`Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.`,"idb-delete":`Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.`,"finalization-registry-not-supported":`FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.`,"invalid-server-app-environment":`FirebaseServerApp is not for use in browser environments.`}),cn=class{constructor(e,t,n){this._isDeleted=!1,this._options={...e},this._config={...t},this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new He(`app`,()=>this,`PUBLIC`))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw x.create(`app-deleted`,{appName:this._name})}},ln=Zt;function un(e,t={}){let n=e;typeof t!=`object`&&(t={name:t});let r={name:Qt,automaticDataCollectionEnabled:!0,...t},i=r.name;if(typeof i!=`string`||!i)throw x.create(`bad-app-name`,{appName:String(i)});if(n||=se(),!n)throw x.create(`no-options`);let a=en.get(i);if(a){if(Pe(n,a.options)&&Pe(r,a.config))return a;throw x.create(`duplicate-app`,{appName:i})}let o=new Ke(i);for(let e of nn.values())o.addComponent(e);let s=new cn(n,r,o);return en.set(i,s),s}function dn(e=Qt){let t=en.get(e);if(!t&&e===`[DEFAULT]`&&se())return un();if(!t)throw x.create(`no-app`,{appName:e});return t}function fn(e,t,n){let r=$t[e]??e;n&&(r+=`-${n}`);let i=r.match(/\s|\//),a=t.match(/\s|\//);if(i||a){let e=[`Unable to register library "${r}" with version "${t}":`];i&&e.push(`library name "${r}" contains illegal characters (whitespace or "/")`),i&&a&&e.push(`and`),a&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),b.warn(e.join(` `));return}an(new He(`${r}-version`,()=>({library:r,version:t}),`VERSION`))}var pn=`firebase-heartbeat-database`,mn=1,hn=`firebase-heartbeat-store`,gn=null;function _n(){return gn||=gt(pn,mn,{upgrade:(e,t)=>{switch(t){case 0:try{e.createObjectStore(hn)}catch(e){console.warn(e)}}}}).catch(e=>{throw x.create(`idb-open`,{originalErrorMessage:e.message})}),gn}async function vn(e){try{let t=(await _n()).transaction(hn),n=await t.objectStore(hn).get(bn(e));return await t.done,n}catch(e){if(e instanceof Ce)b.warn(e.message);else{let t=x.create(`idb-get`,{originalErrorMessage:e?.message});b.warn(t.message)}}}async function yn(e,t){try{let n=(await _n()).transaction(hn,`readwrite`);await n.objectStore(hn).put(t,bn(e)),await n.done}catch(e){if(e instanceof Ce)b.warn(e.message);else{let t=x.create(`idb-set`,{originalErrorMessage:e?.message});b.warn(t.message)}}}function bn(e){return`${e.name}!${e.options.appId}`}var xn=1024,Sn=30,Cn=class{constructor(e){this.container=e,this._heartbeatsCache=null,this._storage=new En(this.container.getProvider(`app`).getImmediate()),this._heartbeatsCachePromise=this._storage.read().then(e=>(this._heartbeatsCache=e,e))}async triggerHeartbeat(){try{let e=this.container.getProvider(`platform-logger`).getImmediate().getPlatformInfoString(),t=wn();if(this._heartbeatsCache?.heartbeats==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null)||this._heartbeatsCache.lastSentHeartbeatDate===t||this._heartbeatsCache.heartbeats.some(e=>e.date===t))return;if(this._heartbeatsCache.heartbeats.push({date:t,agent:e}),this._heartbeatsCache.heartbeats.length>Sn){let e=On(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(e,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){b.warn(e)}}async getHeartbeatsHeader(){try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,this._heartbeatsCache?.heartbeats==null||this._heartbeatsCache.heartbeats.length===0)return``;let e=wn(),{heartbeatsToSend:t,unsentEntries:n}=Tn(this._heartbeatsCache.heartbeats),r=l(JSON.stringify({version:2,heartbeats:t}));return this._heartbeatsCache.lastSentHeartbeatDate=e,n.length>0?(this._heartbeatsCache.heartbeats=n,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return b.warn(e),``}}};function wn(){return new Date().toISOString().substring(0,10)}function Tn(e,t=xn){let n=[],r=e.slice();for(let i of e){let e=n.find(e=>e.agent===i.agent);if(e){if(e.dates.push(i.date),Dn(n)>t){e.dates.pop();break}}else if(n.push({agent:i.agent,dates:[i.date]}),Dn(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}var En=class{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return be()?xe().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){let e=await vn(this.app);return e?.heartbeats?e:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){if(await this._canUseIndexedDBPromise){let t=await this.read();return yn(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??t.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){if(await this._canUseIndexedDBPromise){let t=await this.read();return yn(this.app,{lastSentHeartbeatDate:e.lastSentHeartbeatDate??t.lastSentHeartbeatDate,heartbeats:[...t.heartbeats,...e.heartbeats]})}else return}};function Dn(e){return l(JSON.stringify({version:2,heartbeats:e})).length}function On(e){if(e.length===0)return-1;let t=0,n=e[0].date;for(let r=1;r<e.length;r++)e[r].date<n&&(n=e[r].date,t=r);return t}function kn(e){an(new He(`platform-logger`,e=>new xt(e),`PRIVATE`)),an(new He(`heartbeat`,e=>new Cn(e),`PRIVATE`)),fn(Ct,wt,e),fn(Ct,wt,`esm2020`),fn(`fire-js`,``)}kn(``),fn(`firebase`,`12.7.0`,`app`);var An=`@firebase/database`,jn=`1.1.0`,Mn=``;function Nn(e){Mn=e}var Pn=class{constructor(e){this.domStorage_=e,this.prefix_=`firebase:`}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),h(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:De(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}},Fn=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return g(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}},In=function(e){try{if(typeof window<`u`&&window[e]!==void 0){let t=window[e];return t.setItem(`firebase:sentinel`,`cache`),t.removeItem(`firebase:sentinel`),new Pn(t)}}catch{}return new Fn},S=In(`localStorage`),Ln=In(`sessionStorage`),Rn=new Qe(`@firebase/database`),zn=(function(){let e=1;return function(){return e++}})(),Bn=function(e){let t=ze(e),n=new Le;n.update(t);let r=n.digest();return o.encodeByteArray(r)},Vn=function(...e){let t=``;for(let n=0;n<e.length;n++){let r=e[n];Array.isArray(r)||r&&typeof r==`object`&&typeof r.length==`number`?t+=Vn.apply(null,r):typeof r==`object`?t+=h(r):t+=r,t+=` `}return t},Hn=null,Un=!0,Wn=function(e,t){n(!t||e===!0||e===!1,`Can't turn on custom loggers persistently.`),e===!0?(Rn.logLevel=v.VERBOSE,Hn=Rn.log.bind(Rn),t&&Ln.set(`logging_enabled`,!0)):typeof e==`function`?Hn=e:(Hn=null,Ln.remove(`logging_enabled`))},C=function(...e){if(Un===!0&&(Un=!1,Hn===null&&Ln.get(`logging_enabled`)===!0&&Wn(!0)),Hn){let t=Vn.apply(null,e);Hn(t)}},Gn=function(e){return function(...t){C(e,...t)}},Kn=function(...e){let t=`FIREBASE INTERNAL ERROR: `+Vn(...e);Rn.error(t)},w=function(...e){let t=`FIREBASE FATAL ERROR: ${Vn(...e)}`;throw Rn.error(t),Error(t)},T=function(...e){let t=`FIREBASE WARNING: `+Vn(...e);Rn.warn(t)},qn=function(){typeof window<`u`&&window.location&&window.location.protocol&&window.location.protocol.indexOf(`https:`)!==-1&&T(`Insecure Firebase access from a secure page. Please use https in calls to new Firebase().`)},Jn=function(e){return typeof e==`number`&&(e!==e||e===1/0||e===-1/0)},Yn=function(e){if(m()||document.readyState===`complete`)e();else{let t=!1,n=function(){if(!document.body){setTimeout(n,10);return}t||(t=!0,e())};document.addEventListener?(document.addEventListener(`DOMContentLoaded`,n,!1),window.addEventListener(`load`,n,!1)):document.attachEvent&&(document.attachEvent(`onreadystatechange`,()=>{document.readyState===`complete`&&n()}),window.attachEvent(`onload`,n))}},Xn=`[MIN_NAME]`,Zn=`[MAX_NAME]`,Qn=function(e,t){if(e===t)return 0;if(e===Xn||t===Zn)return-1;if(t===Xn||e===Zn)return 1;{let n=ur(e),r=ur(t);return n===null?r===null&&e<t?-1:1:r===null?-1:n-r===0?e.length-t.length:n-r}},$n=function(e,t){return e===t?0:e<t?-1:1},er=function(e,t){if(t&&e in t)return t[e];throw Error(`Missing required key (`+e+`) in object: `+h(t))},tr=function(e){if(typeof e!=`object`||!e)return h(e);let t=[];for(let n in e)t.push(n);t.sort();let n=`{`;for(let r=0;r<t.length;r++)r!==0&&(n+=`,`),n+=h(t[r]),n+=`:`,n+=tr(e[t[r]]);return n+=`}`,n},nr=function(e,t){let n=e.length;if(n<=t)return[e];let r=[];for(let i=0;i<n;i+=t)i+t>n?r.push(e.substring(i,n)):r.push(e.substring(i,i+t));return r};function E(e,t){for(let n in e)e.hasOwnProperty(n)&&t(n,e[n])}var rr=function(e){n(!Jn(e),`Invalid JSON number`);let t=1023,r,i,a,o,s;e===0?(i=0,a=0,r=1/e==-1/0?1:0):(r=e<0,e=Math.abs(e),e>=2**(1-t)?(o=Math.min(Math.floor(Math.log(e)/Math.LN2),t),i=o+t,a=Math.round(e*2**(52-o)-2**52)):(i=0,a=Math.round(e/2**(1-t-52))));let c=[];for(s=52;s;--s)c.push(a%2?1:0),a=Math.floor(a/2);for(s=11;s;--s)c.push(i%2?1:0),i=Math.floor(i/2);c.push(r?1:0),c.reverse();let l=c.join(``),u=``;for(s=0;s<64;s+=8){let e=parseInt(l.substr(s,8),2).toString(16);e.length===1&&(e=`0`+e),u+=e}return u.toLowerCase()},ir=function(){return!!(typeof window==`object`&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},ar=function(){return typeof Windows==`object`&&typeof Windows.UI==`object`};function or(e,t){let n=`Unknown Error`;e===`too_big`?n=`The data requested exceeds the maximum size that can be accessed with a single request.`:e===`permission_denied`?n=`Client doesn't have permission to access the desired data.`:e===`unavailable`&&(n=`The service is unavailable`);let r=Error(e+` at `+t._path.toString()+`: `+n);return r.code=e.toUpperCase(),r}var sr=RegExp(`^-?(0*)\\d{1,10}$`),cr=-2147483648,lr=2147483647,ur=function(e){if(sr.test(e)){let t=Number(e);if(t>=cr&&t<=lr)return t}return null},dr=function(e){try{e()}catch(e){setTimeout(()=>{throw T(`Exception was thrown by user callback.`,e.stack||``),e},0)}},fr=function(){return(typeof window==`object`&&window.navigator&&window.navigator.userAgent||``).search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},pr=function(e,t){let n=setTimeout(e,t);return typeof n==`number`&&typeof Deno<`u`&&Deno.unrefTimer?Deno.unrefTimer(n):typeof n==`object`&&n.unref&&n.unref(),n},mr=class{constructor(e,t){this.appCheckProvider=t,this.appName=e.name,sn(e)&&e.settings.appCheckToken&&(this.serverAppAppCheckToken=e.settings.appCheckToken),this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(e=>this.appCheck=e)}getToken(e){if(this.serverAppAppCheckToken){if(e)throw Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(e):new Promise((t,n)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,n):t(null)},0)})}addTokenChangeListener(e){this.appCheckProvider?.get().then(t=>t.addTokenListener(e))}notifyForInvalidToken(){T(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}},hr=class{constructor(e,t,n){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=n,this.auth_=null,this.auth_=n.getImmediate({optional:!0}),this.auth_||n.onInit(e=>this.auth_=e)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(e=>e&&e.code===`auth/token-not-initialized`?(C(`Got auth/token-not-initialized error.  Treating as null token.`),null):Promise.reject(e)):new Promise((t,n)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,n):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e=`Provided authentication credentials for the app named "`+this.appName_+`" are invalid. This usually indicates your app was not initialized correctly. `;`credential`in this.firebaseOptions_?e+=`Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.`:`serviceAccount`in this.firebaseOptions_?e+=`Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.`:e+=`Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.`,T(e)}},gr=class{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}};gr.OWNER=`owner`;var _r=`5`,vr=`v`,yr=`s`,br=`r`,xr=`f`,Sr=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,Cr=`ls`,wr=`p`,Tr=`ac`,Er=`websocket`,Dr=`long_polling`,Or=class{constructor(e,t,n,r,i=!1,a=``,o=!1,s=!1,c=null){this.secure=t,this.namespace=n,this.webSocketOnly=r,this.nodeAdmin=i,this.persistenceKey=a,this.includeNamespaceInQueryParams=o,this.isUsingEmulator=s,this.emulatorOptions=c,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(`.`)+1),this.internalHost=S.get(`host:`+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)===`s-`}isCustomHost(){return this._domain!==`firebaseio.com`&&this._domain!==`firebaseio-demo.com`}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&S.set(`host:`+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+=`<`+this.persistenceKey+`>`),e}toURLString(){let e=this.secure?`https://`:`http://`,t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:``;return`${e}${this.host}/${t}`}};function kr(e){return e.host!==e.internalHost||e.isCustomHost()||e.includeNamespaceInQueryParams}function Ar(e,t,r){n(typeof t==`string`,`typeof type must == string`),n(typeof r==`object`,`typeof params must == object`);let i;if(t===Er)i=(e.secure?`wss://`:`ws://`)+e.internalHost+`/.ws?`;else if(t===Dr)i=(e.secure?`https://`:`http://`)+e.internalHost+`/.lp?`;else throw Error(`Unknown connection type: `+t);kr(e)&&(r.ns=e.namespace);let a=[];return E(r,(e,t)=>{a.push(e+`=`+t)}),i+a.join(`&`)}var jr=class{constructor(){this.counters_={}}incrementCounter(e,t=1){g(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return d(this.counters_)}},Mr={},Nr={};function Pr(e){let t=e.toString();return Mr[t]||(Mr[t]=new jr),Mr[t]}function Fr(e,t){let n=e.toString();return Nr[n]||(Nr[n]=t()),Nr[n]}var Ir=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let e=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let t=0;t<e.length;++t)e[t]&&dr(()=>{this.onMessage_(e[t])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&=(this.onClose(),null);break}this.currentResponseNum++}}},Lr=`start`,Rr=`close`,zr=`pLPCommand`,Br=`pRTLPCB`,Vr=`id`,Hr=`pw`,Ur=`ser`,Wr=`cb`,Gr=`dframe`,Kr=1870,qr=30,Jr=Kr-qr,Yr=25e3,Xr=3e4,Zr=class e{constructor(e,t,n,r,i,a,o){this.connId=e,this.repoInfo=t,this.applicationId=n,this.appCheckToken=r,this.authToken=i,this.transportSessionId=a,this.lastSessionId=o,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Gn(e),this.stats_=Pr(t),this.urlFn=e=>(this.appCheckToken&&(e[Tr]=this.appCheckToken),Ar(t,Dr,e))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Ir(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_(`Timed out trying to connect.`),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(Xr)),Yn(()=>{if(this.isClosed_)return;this.scriptTagHolder=new Qr((...e)=>{let[t,n,r,i,a]=e;if(this.incrementIncomingBytes_(e),this.scriptTagHolder)if(this.connectTimeoutTimer_&&=(clearTimeout(this.connectTimeoutTimer_),null),this.everConnected_=!0,t===Lr)this.id=n,this.password=r;else if(t===Rr)n?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(n,()=>{this.onClosed_()})):this.onClosed_();else throw Error(`Unrecognized command received: `+t)},(...e)=>{let[t,n]=e;this.incrementIncomingBytes_(e),this.myPacketOrderer.handleResponse(t,n)},()=>{this.onClosed_()},this.urlFn);let e={};e[Lr]=`t`,e[Ur]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(e[Wr]=this.scriptTagHolder.uniqueCallbackIdentifier),e[vr]=_r,this.transportSessionId&&(e[yr]=this.transportSessionId),this.lastSessionId&&(e[Cr]=this.lastSessionId),this.applicationId&&(e[wr]=this.applicationId),this.appCheckToken&&(e[Tr]=this.appCheckToken),typeof location<`u`&&location.hostname&&Sr.test(location.hostname)&&(e[br]=xr);let t=this.urlFn(e);this.log_(`Connecting via long-poll to `+t),this.scriptTagHolder.addTag(t,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){e.forceAllow_=!0}static forceDisallow(){e.forceDisallow_=!0}static isAvailable(){return m()?!1:e.forceAllow_?!0:!e.forceDisallow_&&typeof document<`u`&&document.createElement!=null&&!ir()&&!ar()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&=(this.scriptTagHolder.close(),null),this.myDisconnFrame&&=(document.body.removeChild(this.myDisconnFrame),null),this.connectTimeoutTimer_&&=(clearTimeout(this.connectTimeoutTimer_),null)}onClosed_(){this.isClosed_||(this.log_(`Longpoll is closing itself`),this.shutdown_(),this.onDisconnect_&&=(this.onDisconnect_(this.everConnected_),null))}close(){this.isClosed_||(this.log_(`Longpoll is being closed.`),this.shutdown_())}send(e){let t=h(e);this.bytesSent+=t.length,this.stats_.incrementCounter(`bytes_sent`,t.length);let n=nr(c(t),Jr);for(let e=0;e<n.length;e++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,n.length,n[e]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(m())return;this.myDisconnFrame=document.createElement(`iframe`);let n={};n[Gr]=`t`,n[Vr]=e,n[Hr]=t,this.myDisconnFrame.src=this.urlFn(n),this.myDisconnFrame.style.display=`none`,document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=h(e).length;this.bytesReceived+=t,this.stats_.incrementCounter(`bytes_received`,t)}},Qr=class e{constructor(t,n,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,m())this.commandCB=t,this.onMessageCB=n;else{this.uniqueCallbackIdentifier=zn(),window[zr+this.uniqueCallbackIdentifier]=t,window[Br+this.uniqueCallbackIdentifier]=n,this.myIFrame=e.createIFrame_();let r=``;this.myIFrame.src&&this.myIFrame.src.substr(0,11)===`javascript:`&&(r=`<script>document.domain="`+document.domain+`";<\/script>`);let i=`<html><body>`+r+`</body></html>`;try{this.myIFrame.doc.open(),this.myIFrame.doc.write(i),this.myIFrame.doc.close()}catch(e){C(`frame writing exception`),e.stack&&C(e.stack),C(e)}}}static createIFrame_(){let e=document.createElement(`iframe`);if(e.style.display=`none`,document.body){document.body.appendChild(e);try{e.contentWindow.document||C(`No IE domain setting required`)}catch{e.src=`javascript:void((function(){document.open();document.domain='`+document.domain+`';document.close();})())`}}else throw`Document body has not initialized. Wait to initialize Firebase until after the document is ready.`;return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent=``,setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},0));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[Vr]=this.myID,e[Hr]=this.myPW,e[Ur]=this.currentSerial;let t=this.urlFn(e),n=``,r=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+qr+n.length<=Kr;){let e=this.pendingSegs.shift();n=n+`&seg`+r+`=`+e.seg+`&ts`+r+`=`+e.ts+`&d`+r+`=`+e.d,r++}return t+=n,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,n){this.pendingSegs.push({seg:e,ts:t,d:n}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let n=()=>{this.outstandingRequests.delete(t),this.newRequest_()},r=setTimeout(n,Math.floor(Yr));this.addTag(e,()=>{clearTimeout(r),n()})}addTag(e,t){m()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let n=this.myIFrame.doc.createElement(`script`);n.type=`text/javascript`,n.async=!0,n.src=e,n.onload=n.onreadystatechange=function(){let e=n.readyState;(!e||e===`loaded`||e===`complete`)&&(n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),t())},n.onerror=()=>{C(`Long-poll script failed to load: `+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(n)}catch{}},1)}},$r=16384,ei=45e3,ti=null;typeof MozWebSocket<`u`?ti=MozWebSocket:typeof WebSocket<`u`&&(ti=WebSocket);var D=class e{constructor(t,n,r,i,a,o,s){this.connId=t,this.applicationId=r,this.appCheckToken=i,this.authToken=a,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Gn(this.connId),this.stats_=Pr(n),this.connURL=e.connectionURL_(n,o,s,i,r),this.nodeAdmin=n.nodeAdmin}static connectionURL_(e,t,n,r,i){let a={};return a[vr]=_r,!m()&&typeof location<`u`&&location.hostname&&Sr.test(location.hostname)&&(a[br]=xr),t&&(a[yr]=t),n&&(a[Cr]=n),r&&(a[Tr]=r),i&&(a[wr]=i),Ar(e,Er,a)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_(`Websocket connecting to `+this.connURL),this.everConnected_=!1,S.set(`previous_websocket_failure`,!0);try{let e;if(m()){let t=this.nodeAdmin?`AdminNode`:`Node`;e={headers:{"User-Agent":`Firebase/${_r}/${Mn}/${process.platform}/${t}`,"X-Firebase-GMPID":this.applicationId||``}},this.authToken&&(e.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(e.headers[`X-Firebase-AppCheck`]=this.appCheckToken);let n={},r=this.connURL.indexOf(`wss://`)===0?n.HTTPS_PROXY||n.https_proxy:n.HTTP_PROXY||n.http_proxy;r&&(e.proxy={origin:r})}this.mySock=new ti(this.connURL,[],e)}catch(e){this.log_(`Error instantiating WebSocket.`);let t=e.message||e.data;t&&this.log_(t),this.onClosed_();return}this.mySock.onopen=()=>{this.log_(`Websocket connected.`),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_(`Websocket connection was disconnected.`),this.mySock=null,this.onClosed_()},this.mySock.onmessage=e=>{this.handleIncomingFrame(e)},this.mySock.onerror=e=>{this.log_(`WebSocket error.  Closing connection.`);let t=e.message||e.data;t&&this.log_(t),this.onClosed_()}}start(){}static forceDisallow(){e.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<`u`&&navigator.userAgent){let e=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);e&&e.length>1&&parseFloat(e[1])<4.4&&(t=!0)}return!t&&ti!==null&&!e.forceDisallow_}static previouslyFailed(){return S.isInMemoryStorage||S.get(`previous_websocket_failure`)===!0}markConnectionHealthy(){S.remove(`previous_websocket_failure`)}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){let e=this.frames.join(``);this.frames=null;let t=De(e);this.onMessage(t)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(n(this.frames===null,`We already have a frame buffer`),e.length<=6){let t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(this.mySock===null)return;let t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter(`bytes_received`,t.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(t);else{let e=this.extractFrameCount_(t);e!==null&&this.appendFrame_(e)}}send(e){this.resetKeepAlive();let t=h(e);this.bytesSent+=t.length,this.stats_.incrementCounter(`bytes_sent`,t.length);let n=nr(t,$r);n.length>1&&this.sendString_(String(n.length));for(let e=0;e<n.length;e++)this.sendString_(n[e])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&=(clearInterval(this.keepaliveTimer),null),this.mySock&&=(this.mySock.close(),null)}onClosed_(){this.isClosed_||(this.log_(`WebSocket is closing itself`),this.shutdown_(),this.onDisconnect&&=(this.onDisconnect(this.everConnected_),null))}close(){this.isClosed_||(this.log_(`WebSocket is being closed`),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_(`0`),this.resetKeepAlive()},Math.floor(ei))}sendString_(e){try{this.mySock.send(e)}catch(e){this.log_(`Exception thrown from WebSocket.send():`,e.message||e.data,`Closing connection.`),setTimeout(this.onClosed_.bind(this),0)}}};D.responsesRequiredToBeHealthy=2,D.healthyTimeout=3e4;var ni=class e{static get ALL_TRANSPORTS(){return[Zr,D]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(e){this.initTransports_(e)}initTransports_(t){let n=D&&D.isAvailable(),r=n&&!D.previouslyFailed();if(t.webSocketOnly&&(n||T(`wss:// URL used, but browser isn't known to support websockets.  Trying anyway.`),r=!0),r)this.transports_=[D];else{let t=this.transports_=[];for(let n of e.ALL_TRANSPORTS)n&&n.isAvailable()&&t.push(n);e.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw Error(`No transports available`)}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}};ni.globalTransportInitialized_=!1;var ri=6e4,ii=5e3,ai=10*1024,oi=100*1024,si=`t`,ci=`d`,li=`s`,ui=`r`,di=`e`,fi=`o`,pi=`a`,mi=`n`,hi=`p`,gi=`h`,_i=class{constructor(e,t,n,r,i,a,o,s,c,l){this.id=e,this.repoInfo_=t,this.applicationId_=n,this.appCheckToken_=r,this.authToken_=i,this.onMessage_=a,this.onReady_=o,this.onDisconnect_=s,this.onKill_=c,this.lastSessionId=l,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Gn(`c:`+this.id+`:`),this.transportManager_=new ni(t),this.log_(`Connection created`),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),n=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,n)},0);let r=e.healthyTimeout||0;r>0&&(this.healthyTimeout_=pr(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>oi?(this.log_(`Connection exceeded healthy timeout but has received `+this.conn_.bytesReceived+` bytes.  Marking connection healthy.`),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>ai?this.log_(`Connection exceeded healthy timeout but has sent `+this.conn_.bytesSent+` bytes.  Leaving connection alive.`):(this.log_(`Closing unhealthy connection after timeout.`),this.close()))},Math.floor(r)))}nextTransportId_(){return`c:`+this.id+`:`+ this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_(`Secondary connection lost.`),this.onSecondaryConnectionLost_()):this.log_(`closing an old connection`)}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_(`message on old connection`))}}sendRequest(e){let t={t:`d`,d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_(`cleaning up and promoting a connection: `+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(si in e){let t=e[si];t===pi?this.upgradeIfSecondaryHealthy_():t===ui?(this.log_(`Got a reset on secondary, closing it`),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===fi&&(this.log_(`got pong on secondary.`),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=er(`t`,e),n=er(`d`,e);if(t===`c`)this.onSecondaryControl_(n);else if(t===`d`)this.pendingDataMessages.push(n);else throw Error(`Unknown protocol layer: `+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_(`Secondary connection is healthy.`),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_(`sending ping on secondary.`),this.secondaryConn_.send({t:`c`,d:{t:hi,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_(`sending client ack on secondary`),this.secondaryConn_.send({t:`c`,d:{t:pi,d:{}}}),this.log_(`Ending transmission on primary`),this.conn_.send({t:`c`,d:{t:mi,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=er(`t`,e),n=er(`d`,e);t===`c`?this.onControl_(n):t===`d`&&this.onDataMessage_(n)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_(`Primary connection is healthy.`),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=er(si,e);if(ci in e){let n=e[ci];if(t===gi){let e={...n};this.repoInfo_.isUsingEmulator&&(e.h=this.repoInfo_.host),this.onHandshake_(e)}else if(t===mi){this.log_(`recvd end transmission on primary`),this.rx_=this.secondaryConn_;for(let e=0;e<this.pendingDataMessages.length;++e)this.onDataMessage_(this.pendingDataMessages[e]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===li?this.onConnectionShutdown_(n):t===ui?this.onReset_(n):t===di?Kn(`Server Error: `+n):t===fi?(this.log_(`got pong on primary.`),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Kn(`Unknown control packet command: `+t)}}onHandshake_(e){let t=e.ts,n=e.v,r=e.h;this.sessionId=e.s,this.repoInfo_.host=r,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),_r!==n&&T(`Protocol version mismatch detected`),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),n=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,n),pr(()=>{this.secondaryConn_&&(this.log_(`Timed out trying to upgrade.`),this.secondaryConn_.close())},Math.floor(ri))}onReset_(e){this.log_(`Reset packet received.  New host: `+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_(`Realtime connection established.`),this.conn_=e,this.state_=1,this.onReady_&&=(this.onReady_(t,this.sessionId),null),this.primaryResponsesRequired_===0?(this.log_(`Primary connection is healthy.`),this.isHealthy_=!0):pr(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(ii))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_(`sending ping on primary.`),this.sendData_({t:`c`,d:{t:hi,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_(`Realtime connection failed.`),this.repoInfo_.isCacheableHost()&&(S.remove(`host:`+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_(`Realtime connection lost.`),this.close()}onConnectionShutdown_(e){this.log_(`Connection shutdown command received. Shutting down...`),this.onKill_&&=(this.onKill_(e),null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw`Connection is not connected`;this.tx_.send(e)}close(){this.state_!==2&&(this.log_(`Closing realtime connection.`),this.state_=2,this.closeConnections_(),this.onDisconnect_&&=(this.onDisconnect_(),null))}closeConnections_(){this.log_(`Shutting down all connections`),this.conn_&&=(this.conn_.close(),null),this.secondaryConn_&&=(this.secondaryConn_.close(),null),this.healthyTimeout_&&=(clearTimeout(this.healthyTimeout_),null)}},vi=class{put(e,t,n,r){}merge(e,t,n,r){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,n){}onDisconnectMerge(e,t,n){}onDisconnectCancel(e,t){}reportStats(e){}},yi=class{constructor(e){this.allowedEvents_=e,this.listeners_={},n(Array.isArray(e)&&e.length>0,`Requires a non-empty array`)}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let n=[...this.listeners_[e]];for(let e=0;e<n.length;e++)n[e].callback.apply(n[e].context,t)}}on(e,t,n){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:n});let r=this.getInitialEvent(e);r&&t.apply(n,r)}off(e,t,n){this.validateEventType_(e);let r=this.listeners_[e]||[];for(let e=0;e<r.length;e++)if(r[e].callback===t&&(!n||n===r[e].context)){r.splice(e,1);return}}validateEventType_(e){n(this.allowedEvents_.find(t=>t===e),`Unknown event: `+e)}},bi=class e extends yi{static getInstance(){return new e}constructor(){super([`online`]),this.online_=!0,typeof window<`u`&&window.addEventListener!==void 0&&!ve()&&(window.addEventListener(`online`,()=>{this.online_||(this.online_=!0,this.trigger(`online`,!0))},!1),window.addEventListener(`offline`,()=>{this.online_&&(this.online_=!1,this.trigger(`online`,!1))},!1))}getInitialEvent(e){return n(e===`online`,`Unknown event type: `+e),[this.online_]}currentlyOnline(){return this.online_}},xi=32,Si=768,O=class{constructor(e,t){if(t===void 0){this.pieces_=e.split(`/`);let t=0;for(let e=0;e<this.pieces_.length;e++)this.pieces_[e].length>0&&(this.pieces_[t]=this.pieces_[e],t++);this.pieces_.length=t,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e=``;for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==``&&(e+=`/`+this.pieces_[t]);return e||`/`}};function k(){return new O(``)}function A(e){return e.pieceNum_>=e.pieces_.length?null:e.pieces_[e.pieceNum_]}function j(e){return e.pieces_.length-e.pieceNum_}function M(e){let t=e.pieceNum_;return t<e.pieces_.length&&t++,new O(e.pieces_,t)}function Ci(e){return e.pieceNum_<e.pieces_.length?e.pieces_[e.pieces_.length-1]:null}function wi(e){let t=``;for(let n=e.pieceNum_;n<e.pieces_.length;n++)e.pieces_[n]!==``&&(t+=`/`+encodeURIComponent(String(e.pieces_[n])));return t||`/`}function Ti(e,t=0){return e.pieces_.slice(e.pieceNum_+t)}function Ei(e){if(e.pieceNum_>=e.pieces_.length)return null;let t=[];for(let n=e.pieceNum_;n<e.pieces_.length-1;n++)t.push(e.pieces_[n]);return new O(t,0)}function N(e,t){let n=[];for(let t=e.pieceNum_;t<e.pieces_.length;t++)n.push(e.pieces_[t]);if(t instanceof O)for(let e=t.pieceNum_;e<t.pieces_.length;e++)n.push(t.pieces_[e]);else{let e=t.split(`/`);for(let t=0;t<e.length;t++)e[t].length>0&&n.push(e[t])}return new O(n,0)}function P(e){return e.pieceNum_>=e.pieces_.length}function F(e,t){let n=A(e),r=A(t);if(n===null)return t;if(n===r)return F(M(e),M(t));throw Error(`INTERNAL ERROR: innerPath (`+t+`) is not within outerPath (`+e+`)`)}function Di(e,t){let n=Ti(e,0),r=Ti(t,0);for(let e=0;e<n.length&&e<r.length;e++){let t=Qn(n[e],r[e]);if(t!==0)return t}return n.length===r.length?0:n.length<r.length?-1:1}function Oi(e,t){if(j(e)!==j(t))return!1;for(let n=e.pieceNum_,r=t.pieceNum_;n<=e.pieces_.length;n++,r++)if(e.pieces_[n]!==t.pieces_[r])return!1;return!0}function I(e,t){let n=e.pieceNum_,r=t.pieceNum_;if(j(e)>j(t))return!1;for(;n<e.pieces_.length;){if(e.pieces_[n]!==t.pieces_[r])return!1;++n,++r}return!0}var ki=class{constructor(e,t){this.errorPrefix_=t,this.parts_=Ti(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let e=0;e<this.parts_.length;e++)this.byteLength_+=Be(this.parts_[e]);Mi(this)}};function Ai(e,t){e.parts_.length>0&&(e.byteLength_+=1),e.parts_.push(t),e.byteLength_+=Be(t),Mi(e)}function ji(e){let t=e.parts_.pop();e.byteLength_-=Be(t),e.parts_.length>0&&--e.byteLength_}function Mi(e){if(e.byteLength_>Si)throw Error(e.errorPrefix_+`has a key path longer than 768 bytes (`+e.byteLength_+`).`);if(e.parts_.length>xi)throw Error(e.errorPrefix_+`path specified exceeds the maximum depth that can be written (32) or object contains a cycle `+L(e))}function L(e){return e.parts_.length===0?``:`in property '`+e.parts_.join(`.`)+`'`}var Ni=class e extends yi{static getInstance(){return new e}constructor(){super([`visible`]);let e,t;typeof document<`u`&&document.addEventListener!==void 0&&(document.hidden===void 0?document.mozHidden===void 0?document.msHidden===void 0?document.webkitHidden!==void 0&&(t=`webkitvisibilitychange`,e=`webkitHidden`):(t=`msvisibilitychange`,e=`msHidden`):(t=`mozvisibilitychange`,e=`mozHidden`):(t=`visibilitychange`,e=`hidden`)),this.visible_=!0,t&&document.addEventListener(t,()=>{let t=!document[e];t!==this.visible_&&(this.visible_=t,this.trigger(`visible`,t))},!1)}getInitialEvent(e){return n(e===`visible`,`Unknown event type: `+e),[this.visible_]}},Pi=1e3,Fi=300*1e3,Ii=30*1e3,Li=1.3,Ri=3e4,zi=`server_kill`,Bi=3,Vi=class e extends vi{constructor(t,n,r,i,a,o,s,c){if(super(),this.repoInfo_=t,this.applicationId_=n,this.onDataUpdate_=r,this.onConnectStatus_=i,this.onServerInfoUpdate_=a,this.authTokenProvider_=o,this.appCheckTokenProvider_=s,this.authOverride_=c,this.id=e.nextPersistentConnectionId_++,this.log_=Gn(`p:`+this.id+`:`),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=Pi,this.maxReconnectDelay_=Fi,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!m())throw Error(`Auth override specified in options, but not supported on non Node.js platforms`);Ni.getInstance().on(`visible`,this.onVisible_,this),t.host.indexOf(`fblocal`)===-1&&bi.getInstance().on(`online`,this.onOnline_,this)}sendRequest(e,t,r){let i=++this.requestNumber_,a={r:i,a:e,b:t};this.log_(h(a)),n(this.connected_,`sendRequest call when we're not connected not allowed.`),this.realtime_.sendRequest(a),r&&(this.requestCBHash_[i]=r)}get(e){this.initConnection_();let t=new ce,n={action:`g`,request:{p:e._path.toString(),q:e._queryObject},onComplete:e=>{let n=e.d;e.s===`ok`?t.resolve(n):t.reject(n)}};this.outstandingGets_.push(n),this.outstandingGetCount_++;let r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,r,i){this.initConnection_();let a=e._queryIdentifier,o=e._path.toString();this.log_(`Listen called for `+o+` `+a),this.listens.has(o)||this.listens.set(o,new Map),n(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),`listen() called for non-default but complete query`),n(!this.listens.get(o).has(a),`listen() called twice for same path/queryId.`);let s={onComplete:i,hashFn:t,query:e,tag:r};this.listens.get(o).set(a,s),this.connected_&&this.sendListen_(s)}sendGet_(e){let t=this.outstandingGets_[e];this.sendRequest(`g`,t.request,n=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(n)})}sendListen_(t){let n=t.query,r=n._path.toString(),i=n._queryIdentifier;this.log_(`Listen on `+r+` for `+i);let a={p:r};t.tag&&(a.q=n._queryObject,a.t=t.tag),a.h=t.hashFn(),this.sendRequest(`q`,a,a=>{let o=a.d,s=a.s;e.warnOnListenWarnings_(o,n),(this.listens.get(r)&&this.listens.get(r).get(i))===t&&(this.log_(`listen response`,a),s!==`ok`&&this.removeListen_(r,i),t.onComplete&&t.onComplete(s,o))})}static warnOnListenWarnings_(e,t){if(e&&typeof e==`object`&&g(e,`w`)){let n=je(e,`w`);Array.isArray(n)&&~n.indexOf(`no_index`)&&T(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${`".indexOn": "`+t._queryParams.getIndex().toString()+`"`} at ${t._path.toString()} to your security rules for better performance.`)}}refreshAuthToken(e){this.authToken_=e,this.log_(`Auth token refreshed`),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest(`unauth`,{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&e.length===40||Ae(e))&&(this.log_(`Admin auth credential detected.  Reducing max reconnect time.`),this.maxReconnectDelay_=Ii)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_(`App check token refreshed`),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest(`unappeck`,{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let e=this.authToken_,t=ke(e)?`auth`:`gauth`,n={cred:e};this.authOverride_===null?n.noauth=!0:typeof this.authOverride_==`object`&&(n.authvar=this.authOverride_),this.sendRequest(t,n,t=>{let n=t.s,r=t.d||`error`;this.authToken_===e&&(n===`ok`?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(n,r))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest(`appcheck`,{token:this.appCheckToken_},e=>{let t=e.s,n=e.d||`error`;t===`ok`?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,n)})}unlisten(e,t){let r=e._path.toString(),i=e._queryIdentifier;this.log_(`Unlisten called for `+r+` `+i),n(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),`unlisten() called for non-default but complete query`),this.removeListen_(r,i)&&this.connected_&&this.sendUnlisten_(r,i,e._queryObject,t)}sendUnlisten_(e,t,n,r){this.log_(`Unlisten on `+e+` for `+t);let i={p:e};r&&(i.q=n,i.t=r),this.sendRequest(`n`,i)}onDisconnectPut(e,t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_(`o`,e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:`o`,data:t,onComplete:n})}onDisconnectMerge(e,t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_(`om`,e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:`om`,data:t,onComplete:n})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_(`oc`,e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:`oc`,data:null,onComplete:t})}sendOnDisconnect_(e,t,n,r){let i={p:t,d:n};this.log_(`onDisconnect `+e,i),this.sendRequest(e,i,e=>{r&&setTimeout(()=>{r(e.s,e.d)},0)})}put(e,t,n,r){this.putInternal(`p`,e,t,n,r)}merge(e,t,n,r){this.putInternal(`m`,e,t,n,r)}putInternal(e,t,n,r,i){this.initConnection_();let a={p:t,d:n};i!==void 0&&(a.h=i),this.outstandingPuts_.push({action:e,request:a,onComplete:r}),this.outstandingPutCount_++;let o=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(o):this.log_(`Buffering put: `+t)}sendPut_(e){let t=this.outstandingPuts_[e].action,n=this.outstandingPuts_[e].request,r=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,n,n=>{this.log_(t+` response`,n),delete this.outstandingPuts_[e],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),r&&r(n.s,n.d)})}reportStats(e){if(this.connected_){let t={c:e};this.log_(`reportStats`,t),this.sendRequest(`s`,t,e=>{if(e.s!==`ok`){let t=e.d;this.log_(`reportStats`,`Error sending stats: `+t)}})}}onDataMessage_(e){if(`r`in e){this.log_(`from server: `+h(e));let t=e.r,n=this.requestCBHash_[t];n&&(delete this.requestCBHash_[t],n(e.b))}else if(`error`in e)throw`A server-side error has occurred: `+e.error;else `a`in e&&this.onDataPush_(e.a,e.b)}onDataPush_(e,t){this.log_(`handleServerMessage`,e,t),e===`d`?this.onDataUpdate_(t.p,t.d,!1,t.t):e===`m`?this.onDataUpdate_(t.p,t.d,!0,t.t):e===`c`?this.onListenRevoked_(t.p,t.q):e===`ac`?this.onAuthRevoked_(t.s,t.d):e===`apc`?this.onAppCheckRevoked_(t.s,t.d):e===`sd`?this.onSecurityDebugPacket_(t):Kn(`Unrecognized action received from server: `+h(e)+`
Are you using the latest client?`)}onReady_(e,t){this.log_(`connection ready`),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){n(!this.realtime_,`Scheduling a connect when we're already connected/ing?`),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_(`Window became visible.  Reducing delay.`),this.reconnectDelay_=Pi,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_(`Browser went online.`),this.reconnectDelay_=Pi,this.realtime_||this.scheduleConnect_(0)):(this.log_(`Browser went offline.  Killing connection.`),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_(`data client disconnected`),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&=(new Date().getTime()-this.lastConnectionEstablishedTime_>Ri&&(this.reconnectDelay_=Pi),null):(this.log_(`Window isn't visible.  Delaying reconnect.`),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let e=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_),t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_(`Trying to reconnect in `+t+`ms`),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*Li)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_(`Making a connection attempt`),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),r=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),a=this.id+`:`+ e.nextConnectionId_++,o=this.lastSessionId,s=!1,c=null,l=function(){c?c.close():(s=!0,i())};this.realtime_={close:l,sendRequest:function(e){n(c,`sendRequest call when we're not connected not allowed.`),c.sendRequest(e)}};let u=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[e,n]=await Promise.all([this.authTokenProvider_.getToken(u),this.appCheckTokenProvider_.getToken(u)]);s?C(`getToken() completed but was canceled`):(C(`getToken() completed. Creating connection.`),this.authToken_=e&&e.accessToken,this.appCheckToken_=n&&n.token,c=new _i(a,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,r,i,e=>{T(e+` (`+this.repoInfo_.toString()+`)`),this.interrupt(zi)},o))}catch(e){this.log_(`Failed to get token: `+e),s||(this.repoInfo_.nodeAdmin&&T(e),l())}}}interrupt(e){C(`Interrupting connection for reason: `+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&=(clearTimeout(this.establishConnectionTimer_),null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){C(`Resuming connection for reason: `+e),delete this.interruptReasons_[e],Me(this.interruptReasons_)&&(this.reconnectDelay_=Pi,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){let t=e-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){let t=this.outstandingPuts_[e];t&&`h`in t.request&&t.queued&&(t.onComplete&&t.onComplete(`disconnect`),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let n;n=t?t.map(e=>tr(e)).join(`$`):`default`;let r=this.removeListen_(e,n);r&&r.onComplete&&r.onComplete(`permission_denied`)}removeListen_(e,t){let n=new O(e).toString(),r;if(this.listens.has(n)){let e=this.listens.get(n);r=e.get(t),e.delete(t),e.size===0&&this.listens.delete(n)}else r=void 0;return r}onAuthRevoked_(e,t){C(`Auth token revoked: `+e+`/`+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(e===`invalid_token`||e===`permission_denied`)&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=Bi&&(this.reconnectDelay_=Ii,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){C(`App check token revoked: `+e+`/`+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(e===`invalid_token`||e===`permission_denied`)&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=Bi&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):`msg`in e&&console.log(`FIREBASE: `+e.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let e of this.listens.values())for(let t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){let e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){let e={},t=`js`;m()&&(t=this.repoInfo_.nodeAdmin?`admin_node`:`node`),e[`sdk.`+t+`.`+Mn.replace(/\./g,`-`)]=1,ve()?e[`framework.cordova`]=1:ye()&&(e[`framework.reactnative`]=1),this.reportStats(e)}shouldReconnect_(){let e=bi.getInstance().currentlyOnline();return Me(this.interruptReasons_)&&e}};Vi.nextPersistentConnectionId_=0,Vi.nextConnectionId_=0;var R=class e{constructor(e,t){this.name=e,this.node=t}static Wrap(t,n){return new e(t,n)}},Hi=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let n=new R(Xn,e),r=new R(Xn,t);return this.compare(n,r)!==0}minPost(){return R.MIN}},Ui,Wi=class extends Hi{static get __EMPTY_NODE(){return Ui}static set __EMPTY_NODE(e){Ui=e}compare(e,t){return Qn(e.name,t.name)}isDefinedOn(e){throw r(`KeyIndex.isDefinedOn not expected to be called.`)}indexedValueChanged(e,t){return!1}minPost(){return R.MIN}maxPost(){return new R(Zn,Ui)}makePost(e,t){return n(typeof e==`string`,`KeyIndex indexValue must always be a string.`),new R(e,Ui)}toString(){return`.key`}},Gi=new Wi,Ki=class{constructor(e,t,n,r,i=null){this.isReverse_=r,this.resultGenerator_=i,this.nodeStack_=[];let a=1;for(;!e.isEmpty();)if(e=e,a=t?n(e.key,t):1,r&&(a*=-1),a<0)e=this.isReverse_?e.left:e.right;else if(a===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),e=this.isReverse_?e.right:e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(t=this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},z=class e{constructor(t,n,r,i,a){this.key=t,this.value=n,this.color=r??e.RED,this.left=i??B.EMPTY_NODE,this.right=a??B.EMPTY_NODE}copy(t,n,r,i,a){return new e(t??this.key,n??this.value,r??this.color,i??this.left,a??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):i===0?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return B.EMPTY_NODE;let e=this;return!e.left.isRed_()&&!e.left.left.isRed_()&&(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let n,r;if(n=this,t(e,n.key)<0)!n.left.isEmpty()&&!n.left.isRed_()&&!n.left.left.isRed_()&&(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(e,t),null);else{if(n.left.isRed_()&&(n=n.rotateRight_()),!n.right.isEmpty()&&!n.right.isRed_()&&!n.right.left.isRed_()&&(n=n.moveRedRight_()),t(e,n.key)===0){if(n.right.isEmpty())return B.EMPTY_NODE;r=n.right.min_(),n=n.copy(r.key,r.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(e,t))}return n.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){let t=this.copy(null,null,e.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,e.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){return 2**this.check_()<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw Error(`Red node has red child(`+this.key+`,`+this.value+`)`);if(this.right.isRed_())throw Error(`Right child of (`+this.key+`,`+this.value+`) is red`);let e=this.left.check_();if(e!==this.right.check_())throw Error(`Black depths differ`);return e+(this.isRed_()?0:1)}};z.RED=!0,z.BLACK=!1;var qi=class{copy(e,t,n,r,i){return this}insert(e,t,n){return new z(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},B=class e{constructor(t,n=e.EMPTY_NODE){this.comparator_=t,this.root_=n}insert(t,n){return new e(this.comparator_,this.root_.insert(t,n,this.comparator_).copy(null,null,z.BLACK,null,null))}remove(t){return new e(this.comparator_,this.root_.remove(t,this.comparator_).copy(null,null,z.BLACK,null,null))}get(e){let t,n=this.root_;for(;!n.isEmpty();){if(t=this.comparator_(e,n.key),t===0)return n.value;t<0?n=n.left:t>0&&(n=n.right)}return null}getPredecessorKey(e){let t,n=this.root_,r=null;for(;!n.isEmpty();)if(t=this.comparator_(e,n.key),t===0){if(n.left.isEmpty())return r?r.key:null;for(n=n.left;!n.right.isEmpty();)n=n.right;return n.key}else t<0?n=n.left:t>0&&(r=n,n=n.right);throw Error(`Attempted to find predecessor key for a nonexistent key.  What gives?`)}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Ki(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Ki(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Ki(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Ki(this.root_,null,this.comparator_,!0,e)}};B.EMPTY_NODE=new qi;function Ji(e,t){return Qn(e.name,t.name)}function Yi(e,t){return Qn(e,t)}var Xi;function Zi(e){Xi=e}var Qi=function(e){return typeof e==`number`?`number:`+rr(e):`string:`+e},$i=function(e){if(e.isLeafNode()){let t=e.val();n(typeof t==`string`||typeof t==`number`||typeof t==`object`&&g(t,`.sv`),`Priority must be a string or number.`)}else n(e===Xi||e.isEmpty(),`priority of unexpected type.`);n(e===Xi||e.getPriority().isEmpty(),`Priority nodes can't have a priority of their own.`)},ea,ta=class e{static set __childrenNodeConstructor(e){ea=e}static get __childrenNodeConstructor(){return ea}constructor(t,r=e.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=r,this.lazyHash_=null,n(this.value_!==void 0&&this.value_!==null,`LeafNode shouldn't be created with null/undefined value.`),$i(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new e(this.value_,t)}getImmediateChild(t){return t===`.priority`?this.priorityNode_:e.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return P(t)?this:A(t)===`.priority`?this.priorityNode_:e.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(t,n){return t===`.priority`?this.updatePriority(n):n.isEmpty()&&t!==`.priority`?this:e.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,n).updatePriority(this.priorityNode_)}updateChild(t,r){let i=A(t);return i===null?r:r.isEmpty()&&i!==`.priority`?this:(n(i!==`.priority`||j(t)===1,`.priority must be the last token in a path`),this.updateImmediateChild(i,e.__childrenNodeConstructor.EMPTY_NODE.updateChild(M(t),r)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let e=``;this.priorityNode_.isEmpty()||(e+=`priority:`+Qi(this.priorityNode_.val())+`:`);let t=typeof this.value_;e+=t+`:`,t===`number`?e+=rr(this.value_):e+=this.value_,this.lazyHash_=Bn(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===e.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof e.__childrenNodeConstructor?-1:(n(t.isLeafNode(),`Unknown node type`),this.compareToLeafNode_(t))}compareToLeafNode_(t){let r=typeof t.value_,i=typeof this.value_,a=e.VALUE_TYPE_ORDER.indexOf(r),o=e.VALUE_TYPE_ORDER.indexOf(i);return n(a>=0,`Unknown leaf type: `+r),n(o>=0,`Unknown leaf type: `+i),a===o?i===`object`?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-a}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){let t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}else return!1}};ta.VALUE_TYPE_ORDER=[`object`,`boolean`,`number`,`string`];var na,ra;function ia(e){na=e}function aa(e){ra=e}var V=new class extends Hi{compare(e,t){let n=e.node.getPriority(),r=t.node.getPriority(),i=n.compareTo(r);return i===0?Qn(e.name,t.name):i}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return R.MIN}maxPost(){return new R(Zn,new ta(`[PRIORITY-POST]`,ra))}makePost(e,t){return new R(t,new ta(`[PRIORITY-POST]`,na(e)))}toString(){return`.priority`}},oa=Math.log(2),sa=class{constructor(e){let t=e=>parseInt(Math.log(e)/oa,10),n=e=>parseInt(Array(e+1).join(`1`),2);this.count=t(e+1),this.current_=this.count-1;let r=n(this.count);this.bits_=e+1&r}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},ca=function(e,t,n,r){e.sort(t);let i=function(t,r){let a=r-t,o,s;if(a===0)return null;if(a===1)return o=e[t],s=n?n(o):o,new z(s,o.node,z.BLACK,null,null);{let c=parseInt(a/2,10)+t,l=i(t,c),u=i(c+1,r);return o=e[c],s=n?n(o):o,new z(s,o.node,z.BLACK,l,u)}},a=function(t){let r=null,a=null,o=e.length,s=function(t,r){let a=o-t,s=o;o-=t;let l=i(a+1,s),u=e[a];c(new z(n?n(u):u,u.node,r,null,l))},c=function(e){r?(r.left=e,r=e):(a=e,r=e)};for(let e=0;e<t.count;++e){let n=t.nextBitIsOne(),r=2**(t.count-(e+1));n?s(r,z.BLACK):(s(r,z.BLACK),s(r,z.RED))}return a}(new sa(e.length));return new B(r||t,a)},la,ua={},da=class e{static get Default(){return n(ua&&V,`ChildrenNode.ts has not been loaded`),la||=new e({".priority":ua},{".priority":V}),la}constructor(e,t){this.indexes_=e,this.indexSet_=t}get(e){let t=je(this.indexes_,e);if(!t)throw Error(`No index defined for `+e);return t instanceof B?t:null}hasIndex(e){return g(this.indexSet_,e.toString())}addIndex(t,r){n(t!==Gi,`KeyIndex always exists and isn't meant to be added to the IndexMap.`);let i=[],a=!1,o=r.getIterator(R.Wrap),s=o.getNext();for(;s;)a||=t.isDefinedOn(s.node),i.push(s),s=o.getNext();let c;c=a?ca(i,t.getCompare()):ua;let l=t.toString(),u={...this.indexSet_};u[l]=t;let d={...this.indexes_};return d[l]=c,new e(d,u)}addToIndexes(t,r){return new e(Ne(this.indexes_,(e,i)=>{let a=je(this.indexSet_,i);if(n(a,`Missing index implementation for `+i),e===ua)if(a.isDefinedOn(t.node)){let e=[],n=r.getIterator(R.Wrap),i=n.getNext();for(;i;)i.name!==t.name&&e.push(i),i=n.getNext();return e.push(t),ca(e,a.getCompare())}else return ua;else{let n=r.get(t.name),i=e;return n&&(i=i.remove(new R(t.name,n))),i.insert(t,t.node)}}),this.indexSet_)}removeFromIndexes(t,n){return new e(Ne(this.indexes_,e=>{if(e===ua)return e;{let r=n.get(t.name);return r?e.remove(new R(t.name,r)):e}}),this.indexSet_)}},fa,H=class e{static get EMPTY_NODE(){return fa||=new e(new B(Yi),null,da.Default)}constructor(e,t,r){this.children_=e,this.priorityNode_=t,this.indexMap_=r,this.lazyHash_=null,this.priorityNode_&&$i(this.priorityNode_),this.children_.isEmpty()&&n(!this.priorityNode_||this.priorityNode_.isEmpty(),`An empty node cannot have a priority`)}isLeafNode(){return!1}getPriority(){return this.priorityNode_||fa}updatePriority(t){return this.children_.isEmpty()?this:new e(this.children_,t,this.indexMap_)}getImmediateChild(e){if(e===`.priority`)return this.getPriority();{let t=this.children_.get(e);return t===null?fa:t}}getChild(e){let t=A(e);return t===null?this:this.getImmediateChild(t).getChild(M(e))}hasChild(e){return this.children_.get(e)!==null}updateImmediateChild(t,r){if(n(r,`We should always be passing snapshot nodes`),t===`.priority`)return this.updatePriority(r);{let n=new R(t,r),i,a;r.isEmpty()?(i=this.children_.remove(t),a=this.indexMap_.removeFromIndexes(n,this.children_)):(i=this.children_.insert(t,r),a=this.indexMap_.addToIndexes(n,this.children_));let o=i.isEmpty()?fa:this.priorityNode_;return new e(i,o,a)}}updateChild(e,t){let r=A(e);if(r===null)return t;{n(A(e)!==`.priority`||j(e)===1,`.priority must be the last token in a path`);let i=this.getImmediateChild(r).updateChild(M(e),t);return this.updateImmediateChild(r,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let n={},r=0,i=0,a=!0;if(this.forEachChild(V,(o,s)=>{n[o]=s.val(t),r++,a&&e.INTEGER_REGEXP_.test(o)?i=Math.max(i,Number(o)):a=!1}),!t&&a&&i<2*r){let e=[];for(let t in n)e[t]=n[t];return e}else return t&&!this.getPriority().isEmpty()&&(n[`.priority`]=this.getPriority().val()),n}hash(){if(this.lazyHash_===null){let e=``;this.getPriority().isEmpty()||(e+=`priority:`+Qi(this.getPriority().val())+`:`),this.forEachChild(V,(t,n)=>{let r=n.hash();r!==``&&(e+=`:`+t+`:`+r)}),this.lazyHash_=e===``?``:Bn(e)}return this.lazyHash_}getPredecessorChildName(e,t,n){let r=this.resolveIndex_(n);if(r){let n=r.getPredecessorKey(new R(e,t));return n?n.name:null}else return this.children_.getPredecessorKey(e)}getFirstChildName(e){let t=this.resolveIndex_(e);if(t){let e=t.minKey();return e&&e.name}else return this.children_.minKey()}getFirstChild(e){let t=this.getFirstChildName(e);return t?new R(t,this.children_.get(t)):null}getLastChildName(e){let t=this.resolveIndex_(e);if(t){let e=t.maxKey();return e&&e.name}else return this.children_.maxKey()}getLastChild(e){let t=this.getLastChildName(e);return t?new R(t,this.children_.get(t)):null}forEachChild(e,t){let n=this.resolveIndex_(e);return n?n.inorderTraversal(e=>t(e.name,e.node)):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){let n=this.resolveIndex_(t);if(n)return n.getIteratorFrom(e,e=>e);{let n=this.children_.getIteratorFrom(e.name,R.Wrap),r=n.peek();for(;r!=null&&t.compare(r,e)<0;)n.getNext(),r=n.peek();return n}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){let n=this.resolveIndex_(t);if(n)return n.getReverseIteratorFrom(e,e=>e);{let n=this.children_.getReverseIteratorFrom(e.name,R.Wrap),r=n.peek();for(;r!=null&&t.compare(r,e)>0;)n.getNext(),r=n.peek();return n}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===pa?-1:0}withIndex(t){if(t===Gi||this.indexMap_.hasIndex(t))return this;{let n=this.indexMap_.addIndex(t,this.children_);return new e(this.children_,this.priorityNode_,n)}}isIndexed(e){return e===Gi||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{let t=e;if(this.getPriority().equals(t.getPriority()))if(this.children_.count()===t.children_.count()){let e=this.getIterator(V),n=t.getIterator(V),r=e.getNext(),i=n.getNext();for(;r&&i;){if(r.name!==i.name||!r.node.equals(i.node))return!1;r=e.getNext(),i=n.getNext()}return r===null&&i===null}else return!1;else return!1}}resolveIndex_(e){return e===Gi?null:this.indexMap_.get(e.toString())}};H.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;var pa=new class extends H{constructor(){super(new B(Yi),H.EMPTY_NODE,da.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return H.EMPTY_NODE}isEmpty(){return!1}};Object.defineProperties(R,{MIN:{value:new R(Xn,H.EMPTY_NODE)},MAX:{value:new R(Zn,pa)}}),Wi.__EMPTY_NODE=H.EMPTY_NODE,ta.__childrenNodeConstructor=H,Zi(pa),aa(pa);var ma=!0;function U(e,t=null){if(e===null)return H.EMPTY_NODE;if(typeof e==`object`&&`.priority`in e&&(t=e[`.priority`]),n(t===null||typeof t==`string`||typeof t==`number`||typeof t==`object`&&`.sv`in t,`Invalid priority type found: `+typeof t),typeof e==`object`&&`.value`in e&&e[`.value`]!==null&&(e=e[`.value`]),typeof e!=`object`||`.sv`in e)return new ta(e,U(t));if(!(e instanceof Array)&&ma){let n=[],r=!1;if(E(e,(e,t)=>{if(e.substring(0,1)!==`.`){let i=U(t);i.isEmpty()||(r||=!i.getPriority().isEmpty(),n.push(new R(e,i)))}}),n.length===0)return H.EMPTY_NODE;let i=ca(n,Ji,e=>e.name,Yi);if(r){let e=ca(n,V.getCompare());return new H(i,U(t),new da({".priority":e},{".priority":V}))}else return new H(i,U(t),da.Default)}else{let n=H.EMPTY_NODE;return E(e,(t,r)=>{if(g(e,t)&&t.substring(0,1)!==`.`){let e=U(r);(e.isLeafNode()||!e.isEmpty())&&(n=n.updateImmediateChild(t,e))}}),n.updatePriority(U(t))}}ia(U);var ha=class extends Hi{constructor(e){super(),this.indexPath_=e,n(!P(e)&&A(e)!==`.priority`,`Can't create PathIndex with empty path or .priority key`)}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let n=this.extractChild(e.node),r=this.extractChild(t.node),i=n.compareTo(r);return i===0?Qn(e.name,t.name):i}makePost(e,t){let n=U(e);return new R(t,H.EMPTY_NODE.updateChild(this.indexPath_,n))}maxPost(){return new R(Zn,H.EMPTY_NODE.updateChild(this.indexPath_,pa))}toString(){return Ti(this.indexPath_,0).join(`/`)}},ga=new class extends Hi{compare(e,t){let n=e.node.compareTo(t.node);return n===0?Qn(e.name,t.name):n}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return R.MIN}maxPost(){return R.MAX}makePost(e,t){return new R(t,U(e))}toString(){return`.value`}};function _a(e){return{type:`value`,snapshotNode:e}}function va(e,t){return{type:`child_added`,snapshotNode:t,childName:e}}function ya(e,t){return{type:`child_removed`,snapshotNode:t,childName:e}}function ba(e,t,n){return{type:`child_changed`,snapshotNode:t,childName:e,oldSnap:n}}function xa(e,t){return{type:`child_moved`,snapshotNode:t,childName:e}}var Sa=class{constructor(e){this.index_=e}updateChild(e,t,r,i,a,o){n(e.isIndexed(this.index_),`A node must be indexed if only a child is updated`);let s=e.getImmediateChild(t);return s.getChild(i).equals(r.getChild(i))&&s.isEmpty()===r.isEmpty()||(o!=null&&(r.isEmpty()?e.hasChild(t)?o.trackChildChange(ya(t,s)):n(e.isLeafNode(),`A child remove without an old child only makes sense on a leaf node`):s.isEmpty()?o.trackChildChange(va(t,r)):o.trackChildChange(ba(t,r,s))),e.isLeafNode()&&r.isEmpty())?e:e.updateImmediateChild(t,r).withIndex(this.index_)}updateFullNode(e,t,n){return n!=null&&(e.isLeafNode()||e.forEachChild(V,(e,r)=>{t.hasChild(e)||n.trackChildChange(ya(e,r))}),t.isLeafNode()||t.forEachChild(V,(t,r)=>{if(e.hasChild(t)){let i=e.getImmediateChild(t);i.equals(r)||n.trackChildChange(ba(t,r,i))}else n.trackChildChange(va(t,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?H.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}},Ca=class e{constructor(t){this.indexedFilter_=new Sa(t.getIndex()),this.index_=t.getIndex(),this.startPost_=e.getStartPost_(t),this.endPost_=e.getEndPost_(t),this.startIsInclusive_=!t.startAfterSet_,this.endIsInclusive_=!t.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,n=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&n}updateChild(e,t,n,r,i,a){return this.matches(new R(t,n))||(n=H.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,n,r,i,a)}updateFullNode(e,t,n){t.isLeafNode()&&(t=H.EMPTY_NODE);let r=t.withIndex(this.index_);r=r.updatePriority(H.EMPTY_NODE);let i=this;return t.forEachChild(V,(e,t)=>{i.matches(new R(e,t))||(r=r.updateImmediateChild(e,H.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,r,n)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}},wa=class{constructor(e){this.withinDirectionalStart=e=>this.reverse_?this.withinEndPost(e):this.withinStartPost(e),this.withinDirectionalEnd=e=>this.reverse_?this.withinStartPost(e):this.withinEndPost(e),this.withinStartPost=e=>{let t=this.index_.compare(this.rangedFilter_.getStartPost(),e);return this.startIsInclusive_?t<=0:t<0},this.withinEndPost=e=>{let t=this.index_.compare(e,this.rangedFilter_.getEndPost());return this.endIsInclusive_?t<=0:t<0},this.rangedFilter_=new Ca(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,n,r,i,a){return this.rangedFilter_.matches(new R(t,n))||(n=H.EMPTY_NODE),e.getImmediateChild(t).equals(n)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,n,r,i,a):this.fullLimitUpdateChild_(e,t,n,i,a)}updateFullNode(e,t,n){let r;if(t.isLeafNode()||t.isEmpty())r=H.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){r=H.EMPTY_NODE.withIndex(this.index_);let e;e=this.reverse_?t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let n=0;for(;e.hasNext()&&n<this.limit_;){let t=e.getNext();if(this.withinDirectionalStart(t))if(this.withinDirectionalEnd(t))r=r.updateImmediateChild(t.name,t.node),n++;else break;else continue}}else{r=t.withIndex(this.index_),r=r.updatePriority(H.EMPTY_NODE);let e;e=this.reverse_?r.getReverseIterator(this.index_):r.getIterator(this.index_);let n=0;for(;e.hasNext();){let t=e.getNext();n<this.limit_&&this.withinDirectionalStart(t)&&this.withinDirectionalEnd(t)?n++:r=r.updateImmediateChild(t.name,H.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,r,n)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,r,i,a){let o;if(this.reverse_){let e=this.index_.getCompare();o=(t,n)=>e(n,t)}else o=this.index_.getCompare();let s=e;n(s.numChildren()===this.limit_,``);let c=new R(t,r),l=this.reverse_?s.getFirstChild(this.index_):s.getLastChild(this.index_),u=this.rangedFilter_.matches(c);if(s.hasChild(t)){let e=s.getImmediateChild(t),n=i.getChildAfterChild(this.index_,l,this.reverse_);for(;n!=null&&(n.name===t||s.hasChild(n.name));)n=i.getChildAfterChild(this.index_,n,this.reverse_);let d=n==null?1:o(n,c);if(u&&!r.isEmpty()&&d>=0)return a?.trackChildChange(ba(t,r,e)),s.updateImmediateChild(t,r);{a?.trackChildChange(ya(t,e));let r=s.updateImmediateChild(t,H.EMPTY_NODE);return n!=null&&this.rangedFilter_.matches(n)?(a?.trackChildChange(va(n.name,n.node)),r.updateImmediateChild(n.name,n.node)):r}}else if(r.isEmpty())return e;else if(u)return o(l,c)>=0?(a!=null&&(a.trackChildChange(ya(l.name,l.node)),a.trackChildChange(va(t,r))),s.updateImmediateChild(t,r).updateImmediateChild(l.name,H.EMPTY_NODE)):e;else return e}},Ta=class e{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_=``,this.indexStartValue_=null,this.indexStartName_=``,this.indexEndValue_=null,this.indexEndName_=``,this.index_=V}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===``?this.startSet_:this.viewFrom_===`l`}getIndexStartValue(){return n(this.startSet_,`Only valid if start has been set`),this.indexStartValue_}getIndexStartName(){return n(this.startSet_,`Only valid if start has been set`),this.startNameSet_?this.indexStartName_:Xn}hasEnd(){return this.endSet_}getIndexEndValue(){return n(this.endSet_,`Only valid if end has been set`),this.indexEndValue_}getIndexEndName(){return n(this.endSet_,`Only valid if end has been set`),this.endNameSet_?this.indexEndName_:Zn}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==``}getLimit(){return n(this.limitSet_,`Only valid if limit has been set`),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===V}copy(){let t=new e;return t.limitSet_=this.limitSet_,t.limit_=this.limit_,t.startSet_=this.startSet_,t.startAfterSet_=this.startAfterSet_,t.indexStartValue_=this.indexStartValue_,t.startNameSet_=this.startNameSet_,t.indexStartName_=this.indexStartName_,t.endSet_=this.endSet_,t.endBeforeSet_=this.endBeforeSet_,t.indexEndValue_=this.indexEndValue_,t.endNameSet_=this.endNameSet_,t.indexEndName_=this.indexEndName_,t.index_=this.index_,t.viewFrom_=this.viewFrom_,t}};function Ea(e){return e.loadsAllData()?new Sa(e.getIndex()):e.hasLimit()?new wa(e):new Ca(e)}function Da(e){let t={};if(e.isDefault())return t;let r;if(e.index_===V?r=`$priority`:e.index_===ga?r=`$value`:e.index_===Gi?r=`$key`:(n(e.index_ instanceof ha,`Unrecognized index type!`),r=e.index_.toString()),t.orderBy=h(r),e.startSet_){let n=e.startAfterSet_?`startAfter`:`startAt`;t[n]=h(e.indexStartValue_),e.startNameSet_&&(t[n]+=`,`+h(e.indexStartName_))}if(e.endSet_){let n=e.endBeforeSet_?`endBefore`:`endAt`;t[n]=h(e.indexEndValue_),e.endNameSet_&&(t[n]+=`,`+h(e.indexEndName_))}return e.limitSet_&&(e.isViewFromLeft()?t.limitToFirst=e.limit_:t.limitToLast=e.limit_),t}function Oa(e){let t={};if(e.startSet_&&(t.sp=e.indexStartValue_,e.startNameSet_&&(t.sn=e.indexStartName_),t.sin=!e.startAfterSet_),e.endSet_&&(t.ep=e.indexEndValue_,e.endNameSet_&&(t.en=e.indexEndName_),t.ein=!e.endBeforeSet_),e.limitSet_){t.l=e.limit_;let n=e.viewFrom_;n===``&&(n=e.isViewFromLeft()?`l`:`r`),t.vf=n}return e.index_!==V&&(t.i=e.index_.toString()),t}var ka=class e extends vi{reportStats(e){throw Error(`Method not implemented.`)}static getListenId_(e,t){return t===void 0?(n(e._queryParams.isDefault(),`should have a tag if it's not a default query.`),e._path.toString()):`tag$`+t}constructor(e,t,n,r){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=n,this.appCheckTokenProvider_=r,this.log_=Gn(`p:rest:`),this.listens_={}}listen(t,n,r,i){let a=t._path.toString();this.log_(`Listen called for `+a+` `+t._queryIdentifier);let o=e.getListenId_(t,r),s={};this.listens_[o]=s;let c=Da(t._queryParams);this.restRequest_(a+`.json`,c,(e,t)=>{let n=t;if(e===404&&(n=null,e=null),e===null&&this.onDataUpdate_(a,n,!1,r),je(this.listens_,o)===s){let t;t=e?e===401?`permission_denied`:`rest_error:`+e:`ok`,i(t,null)}})}unlisten(t,n){let r=e.getListenId_(t,n);delete this.listens_[r]}get(e){let t=Da(e._queryParams),n=e._path.toString(),r=new ce;return this.restRequest_(n+`.json`,t,(e,t)=>{let i=t;e===404&&(i=null,e=null),e===null?(this.onDataUpdate_(n,i,!1,null),r.resolve(i)):r.reject(Error(i))}),r.promise}refreshAuthToken(e){}restRequest_(e,t={},n){return t.format=`export`,Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([r,i])=>{r&&r.accessToken&&(t.auth=r.accessToken),i&&i.token&&(t.ac=i.token);let a=(this.repoInfo_.secure?`https://`:`http://`)+this.repoInfo_.host+e+`?ns=`+this.repoInfo_.namespace+Ie(t);this.log_(`Sending REST request for `+a);let o=new XMLHttpRequest;o.onreadystatechange=()=>{if(n&&o.readyState===4){this.log_(`REST Response for `+a+` received. status:`,o.status,`response:`,o.responseText);let e=null;if(o.status>=200&&o.status<300){try{e=De(o.responseText)}catch{T(`Failed to parse JSON response for `+a+`: `+o.responseText)}n(null,e)}else o.status!==401&&o.status!==404&&T(`Got unsuccessful REST response for `+a+` Status: `+o.status),n(o.status);n=null}},o.open(`GET`,a,!0),o.send()})}},Aa=class{constructor(){this.rootNode_=H.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function ja(){return{value:null,children:new Map}}function Ma(e,t,n){if(P(t))e.value=n,e.children.clear();else if(e.value!==null)e.value=e.value.updateChild(t,n);else{let r=A(t);e.children.has(r)||e.children.set(r,ja());let i=e.children.get(r);t=M(t),Ma(i,t,n)}}function Na(e,t,n){e.value===null?Pa(e,(e,r)=>{Na(r,new O(t.toString()+`/`+e),n)}):n(t,e.value)}function Pa(e,t){e.children.forEach((e,n)=>{t(n,e)})}var Fa=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t={...e};return this.last_&&E(this.last_,(e,n)=>{t[e]=t[e]-n}),this.last_=e,t}},Ia=10*1e3,La=30*1e3,Ra=300*1e3,za=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new Fa(e);let n=Ia+(La-Ia)*Math.random();pr(this.reportStats_.bind(this),Math.floor(n))}reportStats_(){let e=this.statsListener_.get(),t={},n=!1;E(e,(e,r)=>{r>0&&g(this.statsToReport_,e)&&(t[e]=r,n=!0)}),n&&this.server_.reportStats(t),pr(this.reportStats_.bind(this),Math.floor(Math.random()*2*Ra))}},W;(function(e){e[e.OVERWRITE=0]=`OVERWRITE`,e[e.MERGE=1]=`MERGE`,e[e.ACK_USER_WRITE=2]=`ACK_USER_WRITE`,e[e.LISTEN_COMPLETE=3]=`LISTEN_COMPLETE`})(W||={});function Ba(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Va(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Ha(e){return{fromUser:!1,fromServer:!0,queryId:e,tagged:!0}}var Ua=class e{constructor(e,t,n){this.path=e,this.affectedTree=t,this.revert=n,this.type=W.ACK_USER_WRITE,this.source=Ba()}operationForChild(t){if(P(this.path)){if(this.affectedTree.value!=null)return n(this.affectedTree.children.isEmpty(),`affectedTree should not have overlapping affected paths.`),this;{let n=this.affectedTree.subtree(new O(t));return new e(k(),n,this.revert)}}else return n(A(this.path)===t,`operationForChild called for unrelated child.`),new e(M(this.path),this.affectedTree,this.revert)}},Wa=class e{constructor(e,t){this.source=e,this.path=t,this.type=W.LISTEN_COMPLETE}operationForChild(t){return P(this.path)?new e(this.source,k()):new e(this.source,M(this.path))}},Ga=class e{constructor(e,t,n){this.source=e,this.path=t,this.snap=n,this.type=W.OVERWRITE}operationForChild(t){return P(this.path)?new e(this.source,k(),this.snap.getImmediateChild(t)):new e(this.source,M(this.path),this.snap)}},Ka=class e{constructor(e,t,n){this.source=e,this.path=t,this.children=n,this.type=W.MERGE}operationForChild(t){if(P(this.path)){let n=this.children.subtree(new O(t));return n.isEmpty()?null:n.value?new Ga(this.source,k(),n.value):new e(this.source,k(),n)}else return n(A(this.path)===t,`Can't get a merge for a child not on the path of the operation`),new e(this.source,M(this.path),this.children)}toString(){return`Operation(`+this.path+`: `+this.source.toString()+` merge: `+this.children.toString()+`)`}},G=class{constructor(e,t,n){this.node_=e,this.fullyInitialized_=t,this.filtered_=n}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(P(e))return this.isFullyInitialized()&&!this.filtered_;let t=A(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}},qa=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function Ja(e,t,n,r){let i=[],a=[];return t.forEach(t=>{t.type===`child_changed`&&e.index_.indexedValueChanged(t.oldSnap,t.snapshotNode)&&a.push(xa(t.childName,t.snapshotNode))}),Ya(e,i,`child_removed`,t,r,n),Ya(e,i,`child_added`,t,r,n),Ya(e,i,`child_moved`,a,r,n),Ya(e,i,`child_changed`,t,r,n),Ya(e,i,`value`,t,r,n),i}function Ya(e,t,n,r,i,a){let o=r.filter(e=>e.type===n);o.sort((t,n)=>Za(e,t,n)),o.forEach(n=>{let r=Xa(e,n,a);i.forEach(i=>{i.respondsTo(n.type)&&t.push(i.createEvent(r,e.query_))})})}function Xa(e,t,n){return t.type===`value`||t.type===`child_removed`||(t.prevName=n.getPredecessorChildName(t.childName,t.snapshotNode,e.index_)),t}function Za(e,t,n){if(t.childName==null||n.childName==null)throw r(`Should only compare child_ events.`);let i=new R(t.childName,t.snapshotNode),a=new R(n.childName,n.snapshotNode);return e.index_.compare(i,a)}function Qa(e,t){return{eventCache:e,serverCache:t}}function $a(e,t,n,r){return Qa(new G(t,n,r),e.serverCache)}function eo(e,t,n,r){return Qa(e.eventCache,new G(t,n,r))}function to(e){return e.eventCache.isFullyInitialized()?e.eventCache.getNode():null}function no(e){return e.serverCache.isFullyInitialized()?e.serverCache.getNode():null}var ro,io=()=>(ro||=new B($n),ro),K=class e{static fromObject(t){let n=new e(null);return E(t,(e,t)=>{n=n.set(new O(e),t)}),n}constructor(e,t=io()){this.value=e,this.children=t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:k(),value:this.value};if(P(e))return null;{let n=A(e),r=this.children.get(n);if(r!==null){let i=r.findRootMostMatchingPathAndValue(M(e),t);return i==null?null:{path:N(new O(n),i.path),value:i.value}}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(t){if(P(t))return this;{let n=A(t),r=this.children.get(n);return r===null?new e(null):r.subtree(M(t))}}set(t,n){if(P(t))return new e(n,this.children);{let r=A(t),i=(this.children.get(r)||new e(null)).set(M(t),n),a=this.children.insert(r,i);return new e(this.value,a)}}remove(t){if(P(t))return this.children.isEmpty()?new e(null):new e(null,this.children);{let n=A(t),r=this.children.get(n);if(r){let i=r.remove(M(t)),a;return a=i.isEmpty()?this.children.remove(n):this.children.insert(n,i),this.value===null&&a.isEmpty()?new e(null):new e(this.value,a)}else return this}}get(e){if(P(e))return this.value;{let t=A(e),n=this.children.get(t);return n?n.get(M(e)):null}}setTree(t,n){if(P(t))return n;{let r=A(t),i=(this.children.get(r)||new e(null)).setTree(M(t),n),a;return a=i.isEmpty()?this.children.remove(r):this.children.insert(r,i),new e(this.value,a)}}fold(e){return this.fold_(k(),e)}fold_(e,t){let n={};return this.children.inorderTraversal((r,i)=>{n[r]=i.fold_(N(e,r),t)}),t(e,this.value,n)}findOnPath(e,t){return this.findOnPath_(e,k(),t)}findOnPath_(e,t,n){let r=this.value?n(t,this.value):!1;if(r)return r;if(P(e))return null;{let r=A(e),i=this.children.get(r);return i?i.findOnPath_(M(e),N(t,r),n):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,k(),t)}foreachOnPath_(t,n,r){if(P(t))return this;{this.value&&r(n,this.value);let i=A(t),a=this.children.get(i);return a?a.foreachOnPath_(M(t),N(n,i),r):new e(null)}}foreach(e){this.foreach_(k(),e)}foreach_(e,t){this.children.inorderTraversal((n,r)=>{r.foreach_(N(e,n),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,n)=>{n.value&&e(t,n.value)})}},q=class e{constructor(e){this.writeTree_=e}static empty(){return new e(new K(null))}};function ao(e,t,n){if(P(t))return new q(new K(n));{let r=e.writeTree_.findRootMostValueAndPath(t);if(r!=null){let i=r.path,a=r.value,o=F(i,t);return a=a.updateChild(o,n),new q(e.writeTree_.set(i,a))}else{let r=new K(n);return new q(e.writeTree_.setTree(t,r))}}}function oo(e,t,n){let r=e;return E(n,(e,n)=>{r=ao(r,N(t,e),n)}),r}function so(e,t){return P(t)?q.empty():new q(e.writeTree_.setTree(t,new K(null)))}function co(e,t){return lo(e,t)!=null}function lo(e,t){let n=e.writeTree_.findRootMostValueAndPath(t);return n==null?null:e.writeTree_.get(n.path).getChild(F(n.path,t))}function uo(e){let t=[],n=e.writeTree_.value;return n==null?e.writeTree_.children.inorderTraversal((e,n)=>{n.value!=null&&t.push(new R(e,n.value))}):n.isLeafNode()||n.forEachChild(V,(e,n)=>{t.push(new R(e,n))}),t}function J(e,t){if(P(t))return e;{let n=lo(e,t);return n==null?new q(e.writeTree_.subtree(t)):new q(new K(n))}}function fo(e){return e.writeTree_.isEmpty()}function po(e,t){return mo(k(),e.writeTree_,t)}function mo(e,t,r){if(t.value!=null)return r.updateChild(e,t.value);{let i=null;return t.children.inorderTraversal((t,a)=>{t===`.priority`?(n(a.value!==null,`Priority writes must always be leaf nodes`),i=a.value):r=mo(N(e,t),a,r)}),!r.getChild(e).isEmpty()&&i!==null&&(r=r.updateChild(N(e,`.priority`),i)),r}}function ho(e,t){return Ro(t,e)}function go(e,t,r,i,a){n(i>e.lastWriteId,`Stacking an older write on top of newer ones`),a===void 0&&(a=!0),e.allWrites.push({path:t,snap:r,writeId:i,visible:a}),a&&(e.visibleWrites=ao(e.visibleWrites,t,r)),e.lastWriteId=i}function _o(e,t,r,i){n(i>e.lastWriteId,`Stacking an older merge on top of newer ones`),e.allWrites.push({path:t,children:r,writeId:i,visible:!0}),e.visibleWrites=oo(e.visibleWrites,t,r),e.lastWriteId=i}function vo(e,t){for(let n=0;n<e.allWrites.length;n++){let r=e.allWrites[n];if(r.writeId===t)return r}return null}function yo(e,t){let r=e.allWrites.findIndex(e=>e.writeId===t);n(r>=0,`removeWrite called with nonexistent writeId.`);let i=e.allWrites[r];e.allWrites.splice(r,1);let a=i.visible,o=!1,s=e.allWrites.length-1;for(;a&&s>=0;){let t=e.allWrites[s];t.visible&&(s>=r&&bo(t,i.path)?a=!1:I(i.path,t.path)&&(o=!0)),s--}if(a){if(o)return xo(e),!0;if(i.snap)e.visibleWrites=so(e.visibleWrites,i.path);else{let t=i.children;E(t,t=>{e.visibleWrites=so(e.visibleWrites,N(i.path,t))})}return!0}else return!1}function bo(e,t){if(e.snap)return I(e.path,t);for(let n in e.children)if(e.children.hasOwnProperty(n)&&I(N(e.path,n),t))return!0;return!1}function xo(e){e.visibleWrites=Co(e.allWrites,So,k()),e.allWrites.length>0?e.lastWriteId=e.allWrites[e.allWrites.length-1].writeId:e.lastWriteId=-1}function So(e){return e.visible}function Co(e,t,n){let i=q.empty();for(let a=0;a<e.length;++a){let o=e[a];if(t(o)){let e=o.path,t;if(o.snap)I(n,e)?(t=F(n,e),i=ao(i,t,o.snap)):I(e,n)&&(t=F(e,n),i=ao(i,k(),o.snap.getChild(t)));else if(o.children){if(I(n,e))t=F(n,e),i=oo(i,t,o.children);else if(I(e,n))if(t=F(e,n),P(t))i=oo(i,k(),o.children);else{let e=je(o.children,A(t));if(e){let n=e.getChild(M(t));i=ao(i,k(),n)}}}else throw r(`WriteRecord should have .snap or .children`)}}return i}function wo(e,t,n,r,i){if(!r&&!i){let r=lo(e.visibleWrites,t);if(r!=null)return r;{let r=J(e.visibleWrites,t);return fo(r)?n:n==null&&!co(r,k())?null:po(r,n||H.EMPTY_NODE)}}else{let a=J(e.visibleWrites,t);return!i&&fo(a)?n:!i&&n==null&&!co(a,k())?null:po(Co(e.allWrites,function(e){return(e.visible||i)&&(!r||!~r.indexOf(e.writeId))&&(I(e.path,t)||I(t,e.path))},t),n||H.EMPTY_NODE)}}function To(e,t,n){let r=H.EMPTY_NODE,i=lo(e.visibleWrites,t);if(i)return i.isLeafNode()||i.forEachChild(V,(e,t)=>{r=r.updateImmediateChild(e,t)}),r;if(n){let i=J(e.visibleWrites,t);return n.forEachChild(V,(e,t)=>{let n=po(J(i,new O(e)),t);r=r.updateImmediateChild(e,n)}),uo(i).forEach(e=>{r=r.updateImmediateChild(e.name,e.node)}),r}else return uo(J(e.visibleWrites,t)).forEach(e=>{r=r.updateImmediateChild(e.name,e.node)}),r}function Eo(e,t,r,i,a){n(i||a,`Either existingEventSnap or existingServerSnap must exist`);let o=N(t,r);if(co(e.visibleWrites,o))return null;{let t=J(e.visibleWrites,o);return fo(t)?a.getChild(r):po(t,a.getChild(r))}}function Do(e,t,n,r){let i=N(t,n);return lo(e.visibleWrites,i)??(r.isCompleteForChild(n)?po(J(e.visibleWrites,i),r.getNode().getImmediateChild(n)):null)}function Oo(e,t){return lo(e.visibleWrites,t)}function ko(e,t,n,r,i,a,o){let s,c=J(e.visibleWrites,t),l=lo(c,k());if(l!=null)s=l;else if(n!=null)s=po(c,n);else return[];if(s=s.withIndex(o),!s.isEmpty()&&!s.isLeafNode()){let e=[],t=o.getCompare(),n=a?s.getReverseIteratorFrom(r,o):s.getIteratorFrom(r,o),c=n.getNext();for(;c&&e.length<i;)t(c,r)!==0&&e.push(c),c=n.getNext();return e}else return[]}function Ao(){return{visibleWrites:q.empty(),allWrites:[],lastWriteId:-1}}function jo(e,t,n,r){return wo(e.writeTree,e.treePath,t,n,r)}function Mo(e,t){return To(e.writeTree,e.treePath,t)}function No(e,t,n,r){return Eo(e.writeTree,e.treePath,t,n,r)}function Po(e,t){return Oo(e.writeTree,N(e.treePath,t))}function Fo(e,t,n,r,i,a){return ko(e.writeTree,e.treePath,t,n,r,i,a)}function Io(e,t,n){return Do(e.writeTree,e.treePath,t,n)}function Lo(e,t){return Ro(N(e.treePath,t),e.writeTree)}function Ro(e,t){return{treePath:e,writeTree:t}}var zo=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,i=e.childName;n(t===`child_added`||t===`child_changed`||t===`child_removed`,`Only child changes supported for tracking`),n(i!==`.priority`,`Only non-priority child changes can be tracked.`);let a=this.changeMap.get(i);if(a){let n=a.type;if(t===`child_added`&&n===`child_removed`)this.changeMap.set(i,ba(i,e.snapshotNode,a.snapshotNode));else if(t===`child_removed`&&n===`child_added`)this.changeMap.delete(i);else if(t===`child_removed`&&n===`child_changed`)this.changeMap.set(i,ya(i,a.oldSnap));else if(t===`child_changed`&&n===`child_added`)this.changeMap.set(i,va(i,e.snapshotNode));else if(t===`child_changed`&&n===`child_changed`)this.changeMap.set(i,ba(i,e.snapshotNode,a.oldSnap));else throw r(`Illegal combination of changes: `+e+` occurred after `+a)}else this.changeMap.set(i,e)}getChanges(){return Array.from(this.changeMap.values())}},Bo=new class{getCompleteChild(e){return null}getChildAfterChild(e,t,n){return null}},Vo=class{constructor(e,t,n=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=n}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let t=this.optCompleteServerCache_==null?this.viewCache_.serverCache:new G(this.optCompleteServerCache_,!0,!1);return Io(this.writes_,e,t)}}getChildAfterChild(e,t,n){let r=this.optCompleteServerCache_==null?no(this.viewCache_):this.optCompleteServerCache_,i=Fo(this.writes_,r,t,1,n,e);return i.length===0?null:i[0]}};function Ho(e){return{filter:e}}function Uo(e,t){n(t.eventCache.getNode().isIndexed(e.filter.getIndex()),`Event snap not indexed`),n(t.serverCache.getNode().isIndexed(e.filter.getIndex()),`Server snap not indexed`)}function Wo(e,t,i,a,o){let s=new zo,c,l;if(i.type===W.OVERWRITE){let r=i;r.source.fromUser?c=Jo(e,t,r.path,r.snap,a,o,s):(n(r.source.fromServer,`Unknown source.`),l=r.source.tagged||t.serverCache.isFiltered()&&!P(r.path),c=qo(e,t,r.path,r.snap,a,o,l,s))}else if(i.type===W.MERGE){let r=i;r.source.fromUser?c=Xo(e,t,r.path,r.children,a,o,s):(n(r.source.fromServer,`Unknown source.`),l=r.source.tagged||t.serverCache.isFiltered(),c=Qo(e,t,r.path,r.children,a,o,l,s))}else if(i.type===W.ACK_USER_WRITE){let n=i;c=n.revert?ts(e,t,n.path,a,o,s):$o(e,t,n.path,n.affectedTree,a,o,s)}else if(i.type===W.LISTEN_COMPLETE)c=es(e,t,i.path,a,s);else throw r(`Unknown operation type: `+i.type);let u=s.getChanges();return Go(t,c,u),{viewCache:c,changes:u}}function Go(e,t,n){let r=t.eventCache;if(r.isFullyInitialized()){let i=r.getNode().isLeafNode()||r.getNode().isEmpty(),a=to(e);(n.length>0||!e.eventCache.isFullyInitialized()||i&&!r.getNode().equals(a)||!r.getNode().getPriority().equals(a.getPriority()))&&n.push(_a(to(t)))}}function Ko(e,t,r,i,a,o){let s=t.eventCache;if(Po(i,r)!=null)return t;{let c,l;if(P(r))if(n(t.serverCache.isFullyInitialized(),`If change path is empty, we must have complete server data`),t.serverCache.isFiltered()){let n=no(t),r=Mo(i,n instanceof H?n:H.EMPTY_NODE);c=e.filter.updateFullNode(t.eventCache.getNode(),r,o)}else{let n=jo(i,no(t));c=e.filter.updateFullNode(t.eventCache.getNode(),n,o)}else{let u=A(r);if(u===`.priority`){n(j(r)===1,`Can't have a priority with additional path components`);let a=s.getNode();l=t.serverCache.getNode();let o=No(i,r,a,l);c=o==null?s.getNode():e.filter.updatePriority(a,o)}else{let n=M(r),d;if(s.isCompleteForChild(u)){l=t.serverCache.getNode();let e=No(i,r,s.getNode(),l);d=e==null?s.getNode().getImmediateChild(u):s.getNode().getImmediateChild(u).updateChild(n,e)}else d=Io(i,u,t.serverCache);c=d==null?s.getNode():e.filter.updateChild(s.getNode(),u,d,n,a,o)}}return $a(t,c,s.isFullyInitialized()||P(r),e.filter.filtersNodes())}}function qo(e,t,n,r,i,a,o,s){let c=t.serverCache,l,u=o?e.filter:e.filter.getIndexedFilter();if(P(n))l=u.updateFullNode(c.getNode(),r,null);else if(u.filtersNodes()&&!c.isFiltered()){let e=c.getNode().updateChild(n,r);l=u.updateFullNode(c.getNode(),e,null)}else{let e=A(n);if(!c.isCompleteForPath(n)&&j(n)>1)return t;let i=M(n),a=c.getNode().getImmediateChild(e).updateChild(i,r);l=e===`.priority`?u.updatePriority(c.getNode(),a):u.updateChild(c.getNode(),e,a,i,Bo,null)}let d=eo(t,l,c.isFullyInitialized()||P(n),u.filtersNodes());return Ko(e,d,n,i,new Vo(i,d,a),s)}function Jo(e,t,n,r,i,a,o){let s=t.eventCache,c,l,u=new Vo(i,t,a);if(P(n))l=e.filter.updateFullNode(t.eventCache.getNode(),r,o),c=$a(t,l,!0,e.filter.filtersNodes());else{let i=A(n);if(i===`.priority`)l=e.filter.updatePriority(t.eventCache.getNode(),r),c=$a(t,l,s.isFullyInitialized(),s.isFiltered());else{let a=M(n),l=s.getNode().getImmediateChild(i),d;if(P(a))d=r;else{let e=u.getCompleteChild(i);d=e==null?H.EMPTY_NODE:Ci(a)===`.priority`&&e.getChild(Ei(a)).isEmpty()?e:e.updateChild(a,r)}c=l.equals(d)?t:$a(t,e.filter.updateChild(s.getNode(),i,d,a,u,o),s.isFullyInitialized(),e.filter.filtersNodes())}}return c}function Yo(e,t){return e.eventCache.isCompleteForChild(t)}function Xo(e,t,n,r,i,a,o){let s=t;return r.foreach((r,c)=>{let l=N(n,r);Yo(t,A(l))&&(s=Jo(e,s,l,c,i,a,o))}),r.foreach((r,c)=>{let l=N(n,r);Yo(t,A(l))||(s=Jo(e,s,l,c,i,a,o))}),s}function Zo(e,t,n){return n.foreach((e,n)=>{t=t.updateChild(e,n)}),t}function Qo(e,t,n,r,i,a,o,s){if(t.serverCache.getNode().isEmpty()&&!t.serverCache.isFullyInitialized())return t;let c=t,l;l=P(n)?r:new K(null).setTree(n,r);let u=t.serverCache.getNode();return l.children.inorderTraversal((n,r)=>{if(u.hasChild(n)){let l=Zo(e,t.serverCache.getNode().getImmediateChild(n),r);c=qo(e,c,new O(n),l,i,a,o,s)}}),l.children.inorderTraversal((n,r)=>{let l=!t.serverCache.isCompleteForChild(n)&&r.value===null;if(!u.hasChild(n)&&!l){let l=Zo(e,t.serverCache.getNode().getImmediateChild(n),r);c=qo(e,c,new O(n),l,i,a,o,s)}}),c}function $o(e,t,n,r,i,a,o){if(Po(i,n)!=null)return t;let s=t.serverCache.isFiltered(),c=t.serverCache;if(r.value!=null){if(P(n)&&c.isFullyInitialized()||c.isCompleteForPath(n))return qo(e,t,n,c.getNode().getChild(n),i,a,s,o);if(P(n)){let r=new K(null);return c.getNode().forEachChild(Gi,(e,t)=>{r=r.set(new O(e),t)}),Qo(e,t,n,r,i,a,s,o)}else return t}else{let l=new K(null);return r.foreach((e,t)=>{let r=N(n,e);c.isCompleteForPath(r)&&(l=l.set(e,c.getNode().getChild(r)))}),Qo(e,t,n,l,i,a,s,o)}}function es(e,t,n,r,i){let a=t.serverCache;return Ko(e,eo(t,a.getNode(),a.isFullyInitialized()||P(n),a.isFiltered()),n,r,Bo,i)}function ts(e,t,r,i,a,o){let s;if(Po(i,r)!=null)return t;{let c=new Vo(i,t,a),l=t.eventCache.getNode(),u;if(P(r)||A(r)===`.priority`){let r;if(t.serverCache.isFullyInitialized())r=jo(i,no(t));else{let e=t.serverCache.getNode();n(e instanceof H,`serverChildren would be complete if leaf node`),r=Mo(i,e)}r=r,u=e.filter.updateFullNode(l,r,o)}else{let n=A(r),a=Io(i,n,t.serverCache);a==null&&t.serverCache.isCompleteForChild(n)&&(a=l.getImmediateChild(n)),u=a==null?t.eventCache.getNode().hasChild(n)?e.filter.updateChild(l,n,H.EMPTY_NODE,M(r),c,o):l:e.filter.updateChild(l,n,a,M(r),c,o),u.isEmpty()&&t.serverCache.isFullyInitialized()&&(s=jo(i,no(t)),s.isLeafNode()&&(u=e.filter.updateFullNode(u,s,o)))}return s=t.serverCache.isFullyInitialized()||Po(i,k())!=null,$a(t,u,s,e.filter.filtersNodes())}}var ns=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let n=this.query_._queryParams,r=new Sa(n.getIndex()),i=Ea(n);this.processor_=Ho(i);let a=t.serverCache,o=t.eventCache,s=r.updateFullNode(H.EMPTY_NODE,a.getNode(),null),c=i.updateFullNode(H.EMPTY_NODE,o.getNode(),null),l=new G(s,a.isFullyInitialized(),r.filtersNodes());this.viewCache_=Qa(new G(c,o.isFullyInitialized(),i.filtersNodes()),l),this.eventGenerator_=new qa(this.query_)}get query(){return this.query_}};function rs(e){return e.viewCache_.serverCache.getNode()}function is(e){return to(e.viewCache_)}function as(e,t){let n=no(e.viewCache_);return n&&(e.query._queryParams.loadsAllData()||!P(t)&&!n.getImmediateChild(A(t)).isEmpty())?n.getChild(t):null}function os(e){return e.eventRegistrations_.length===0}function ss(e,t){e.eventRegistrations_.push(t)}function cs(e,t,r){let i=[];if(r){n(t==null,`A cancel should cancel all event registrations.`);let a=e.query._path;e.eventRegistrations_.forEach(e=>{let t=e.createCancelEvent(r,a);t&&i.push(t)})}if(t){let n=[];for(let r=0;r<e.eventRegistrations_.length;++r){let i=e.eventRegistrations_[r];if(!i.matches(t))n.push(i);else if(t.hasAnyCallback()){n=n.concat(e.eventRegistrations_.slice(r+1));break}}e.eventRegistrations_=n}else e.eventRegistrations_=[];return i}function ls(e,t,r,i){t.type===W.MERGE&&t.source.queryId!==null&&(n(no(e.viewCache_),`We should always have a full cache before handling merges`),n(to(e.viewCache_),`Missing event cache, even though we have a server cache`));let a=e.viewCache_,o=Wo(e.processor_,a,t,r,i);return Uo(e.processor_,o.viewCache),n(o.viewCache.serverCache.isFullyInitialized()||!a.serverCache.isFullyInitialized(),`Once a server snap is complete, it should never go back`),e.viewCache_=o.viewCache,ds(e,o.changes,o.viewCache.eventCache.getNode(),null)}function us(e,t){let n=e.viewCache_.eventCache,r=[];return n.getNode().isLeafNode()||n.getNode().forEachChild(V,(e,t)=>{r.push(va(e,t))}),n.isFullyInitialized()&&r.push(_a(n.getNode())),ds(e,r,n.getNode(),t)}function ds(e,t,n,r){let i=r?[r]:e.eventRegistrations_;return Ja(e.eventGenerator_,t,n,i)}var fs,ps=class{constructor(){this.views=new Map}};function ms(e){n(!fs,`__referenceConstructor has already been defined`),fs=e}function hs(){return n(fs,`Reference.ts has not been loaded`),fs}function gs(e){return e.views.size===0}function _s(e,t,r,i){let a=t.source.queryId;if(a!==null){let o=e.views.get(a);return n(o!=null,`SyncTree gave us an op for an invalid query.`),ls(o,t,r,i)}else{let n=[];for(let a of e.views.values())n=n.concat(ls(a,t,r,i));return n}}function vs(e,t,n,r,i){let a=t._queryIdentifier,o=e.views.get(a);if(!o){let e=jo(n,i?r:null),a=!1;return e?a=!0:r instanceof H?(e=Mo(n,r),a=!1):(e=H.EMPTY_NODE,a=!1),new ns(t,Qa(new G(e,a,!1),new G(r,i,!1)))}return o}function ys(e,t,n,r,i,a){let o=vs(e,t,r,i,a);return e.views.has(t._queryIdentifier)||e.views.set(t._queryIdentifier,o),ss(o,n),us(o,n)}function bs(e,t,n,r){let i=t._queryIdentifier,a=[],o=[],s=X(e);if(i===`default`)for(let[t,i]of e.views.entries())o=o.concat(cs(i,n,r)),os(i)&&(e.views.delete(t),i.query._queryParams.loadsAllData()||a.push(i.query));else{let t=e.views.get(i);t&&(o=o.concat(cs(t,n,r)),os(t)&&(e.views.delete(i),t.query._queryParams.loadsAllData()||a.push(t.query)))}return s&&!X(e)&&a.push(new(hs())(t._repo,t._path)),{removed:a,events:o}}function xs(e){let t=[];for(let n of e.views.values())n.query._queryParams.loadsAllData()||t.push(n);return t}function Y(e,t){let n=null;for(let r of e.views.values())n||=as(r,t);return n}function Ss(e,t){if(t._queryParams.loadsAllData())return ws(e);{let n=t._queryIdentifier;return e.views.get(n)}}function Cs(e,t){return Ss(e,t)!=null}function X(e){return ws(e)!=null}function ws(e){for(let t of e.views.values())if(t.query._queryParams.loadsAllData())return t;return null}var Ts;function Es(e){n(!Ts,`__referenceConstructor has already been defined`),Ts=e}function Ds(){return n(Ts,`Reference.ts has not been loaded`),Ts}var Os=1,ks=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new K(null),this.pendingWriteTree_=Ao(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function As(e,t,n,r,i){return go(e.pendingWriteTree_,t,n,r,i),i?Hs(e,new Ga(Ba(),t,n)):[]}function js(e,t,n,r){_o(e.pendingWriteTree_,t,n,r);let i=K.fromObject(n);return Hs(e,new Ka(Ba(),t,i))}function Z(e,t,n=!1){let r=vo(e.pendingWriteTree_,t);if(yo(e.pendingWriteTree_,t)){let t=new K(null);return r.snap==null?E(r.children,e=>{t=t.set(new O(e),!0)}):t=t.set(k(),!0),Hs(e,new Ua(r.path,t,n))}else return[]}function Ms(e,t,n){return Hs(e,new Ga(Va(),t,n))}function Ns(e,t,n){let r=K.fromObject(n);return Hs(e,new Ka(Va(),t,r))}function Ps(e,t){return Hs(e,new Wa(Va(),t))}function Fs(e,t,n){let r=Js(e,n);if(r){let n=Ys(r),i=n.path,a=n.queryId,o=F(i,t);return Xs(e,i,new Wa(Ha(a),o))}else return[]}function Is(e,t,n,r,i=!1){let a=t._path,o=e.syncPointTree_.get(a),s=[];if(o&&(t._queryIdentifier===`default`||Cs(o,t))){let c=bs(o,t,n,r);gs(o)&&(e.syncPointTree_=e.syncPointTree_.remove(a));let l=c.removed;if(s=c.events,!i){let n=l.findIndex(e=>e._queryParams.loadsAllData())!==-1,i=e.syncPointTree_.findOnPath(a,(e,t)=>X(t));if(n&&!i){let t=e.syncPointTree_.subtree(a);if(!t.isEmpty()){let n=Zs(t);for(let t=0;t<n.length;++t){let r=n[t],i=r.query,a=Gs(e,r);e.listenProvider_.startListening(Qs(i),Ks(e,i),a.hashFn,a.onComplete)}}}!i&&l.length>0&&!r&&(n?e.listenProvider_.stopListening(Qs(t),null):l.forEach(t=>{let n=e.queryToTagMap.get(qs(t));e.listenProvider_.stopListening(Qs(t),n)}))}$s(e,l)}return s}function Ls(e,t,n,r){let i=Js(e,r);if(i!=null){let r=Ys(i),a=r.path,o=r.queryId,s=F(a,t);return Xs(e,a,new Ga(Ha(o),s,n))}else return[]}function Rs(e,t,n,r){let i=Js(e,r);if(i){let r=Ys(i),a=r.path,o=r.queryId,s=F(a,t),c=K.fromObject(n);return Xs(e,a,new Ka(Ha(o),s,c))}else return[]}function zs(e,t,r,i=!1){let a=t._path,o=null,s=!1;e.syncPointTree_.foreachOnPath(a,(e,t)=>{let n=F(e,a);o||=Y(t,n),s||=X(t)});let c=e.syncPointTree_.get(a);c?(s||=X(c),o||=Y(c,k())):(c=new ps,e.syncPointTree_=e.syncPointTree_.set(a,c));let l;o==null?(l=!1,o=H.EMPTY_NODE,e.syncPointTree_.subtree(a).foreachChild((e,t)=>{let n=Y(t,k());n&&(o=o.updateImmediateChild(e,n))})):l=!0;let u=Cs(c,t);if(!u&&!t._queryParams.loadsAllData()){let r=qs(t);n(!e.queryToTagMap.has(r),`View does not exist, but we have a tag`);let i=ec();e.queryToTagMap.set(r,i),e.tagToQueryMap.set(i,r)}let d=ho(e.pendingWriteTree_,a),f=ys(c,t,r,d,o,l);if(!u&&!s&&!i){let n=Ss(c,t);f=f.concat(tc(e,t,n))}return f}function Bs(e,t,n){let r=e.pendingWriteTree_;return wo(r,t,e.syncPointTree_.findOnPath(t,(e,n)=>{let r=Y(n,F(e,t));if(r)return r}),n,!0)}function Vs(e,t){let n=t._path,r=null;e.syncPointTree_.foreachOnPath(n,(e,t)=>{let i=F(e,n);r||=Y(t,i)});let i=e.syncPointTree_.get(n);i?r||=Y(i,k()):(i=new ps,e.syncPointTree_=e.syncPointTree_.set(n,i));let a=r!=null,o=a?new G(r,!0,!1):null,s=ho(e.pendingWriteTree_,t._path);return is(vs(i,t,s,a?o.getNode():H.EMPTY_NODE,a))}function Hs(e,t){return Us(t,e.syncPointTree_,null,ho(e.pendingWriteTree_,k()))}function Us(e,t,n,r){if(P(e.path))return Ws(e,t,n,r);{let i=t.get(k());n==null&&i!=null&&(n=Y(i,k()));let a=[],o=A(e.path),s=e.operationForChild(o),c=t.children.get(o);if(c&&s){let e=n?n.getImmediateChild(o):null,t=Lo(r,o);a=a.concat(Us(s,c,e,t))}return i&&(a=a.concat(_s(i,e,r,n))),a}}function Ws(e,t,n,r){let i=t.get(k());n==null&&i!=null&&(n=Y(i,k()));let a=[];return t.children.inorderTraversal((t,i)=>{let o=n?n.getImmediateChild(t):null,s=Lo(r,t),c=e.operationForChild(t);c&&(a=a.concat(Ws(c,i,o,s)))}),i&&(a=a.concat(_s(i,e,r,n))),a}function Gs(e,t){let n=t.query,r=Ks(e,n);return{hashFn:()=>(rs(t)||H.EMPTY_NODE).hash(),onComplete:t=>t===`ok`?r?Fs(e,n._path,r):Ps(e,n._path):Is(e,n,null,or(t,n))}}function Ks(e,t){let n=qs(t);return e.queryToTagMap.get(n)}function qs(e){return e._path.toString()+`$`+e._queryIdentifier}function Js(e,t){return e.tagToQueryMap.get(t)}function Ys(e){let t=e.indexOf(`$`);return n(t!==-1&&t<e.length-1,`Bad queryKey.`),{queryId:e.substr(t+1),path:new O(e.substr(0,t))}}function Xs(e,t,r){let i=e.syncPointTree_.get(t);return n(i,`Missing sync point for query tag that we're tracking`),_s(i,r,ho(e.pendingWriteTree_,t),null)}function Zs(e){return e.fold((e,t,n)=>{if(t&&X(t))return[ws(t)];{let e=[];return t&&(e=xs(t)),E(n,(t,n)=>{e=e.concat(n)}),e}})}function Qs(e){return e._queryParams.loadsAllData()&&!e._queryParams.isDefault()?new(Ds())(e._repo,e._path):e}function $s(e,t){for(let n=0;n<t.length;++n){let r=t[n];if(!r._queryParams.loadsAllData()){let t=qs(r),n=e.queryToTagMap.get(t);e.queryToTagMap.delete(t),e.tagToQueryMap.delete(n)}}}function ec(){return Os++}function tc(e,t,r){let i=t._path,a=Ks(e,t),o=Gs(e,r),s=e.listenProvider_.startListening(Qs(t),a,o.hashFn,o.onComplete),c=e.syncPointTree_.subtree(i);if(a)n(!X(c.value),`If we're adding a query, it shouldn't be shadowed`);else{let t=c.fold((e,t,n)=>{if(!P(e)&&t&&X(t))return[ws(t).query];{let e=[];return t&&(e=e.concat(xs(t).map(e=>e.query))),E(n,(t,n)=>{e=e.concat(n)}),e}});for(let n=0;n<t.length;++n){let r=t[n];e.listenProvider_.stopListening(Qs(r),Ks(e,r))}}return s}var nc=class e{constructor(e){this.node_=e}getImmediateChild(t){return new e(this.node_.getImmediateChild(t))}node(){return this.node_}},rc=class e{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(t){let n=N(this.path_,t);return new e(this.syncTree_,n)}node(){return Bs(this.syncTree_,this.path_)}},ic=function(e){return e||={},e.timestamp=e.timestamp||new Date().getTime(),e},ac=function(e,t,r){if(!e||typeof e!=`object`)return e;if(n(`.sv`in e,`Unexpected leaf node or priority contents`),typeof e[`.sv`]==`string`)return oc(e[`.sv`],t,r);if(typeof e[`.sv`]==`object`)return sc(e[`.sv`],t);n(!1,`Unexpected server value: `+JSON.stringify(e,null,2))},oc=function(e,t,r){switch(e){case`timestamp`:return r.timestamp;default:n(!1,`Unexpected server value: `+e)}},sc=function(e,t,r){e.hasOwnProperty(`increment`)||n(!1,`Unexpected server value: `+JSON.stringify(e,null,2));let i=e.increment;typeof i!=`number`&&n(!1,`Unexpected increment value: `+i);let a=t.node();if(n(a!=null,`Expected ChildrenNode.EMPTY_NODE for nulls`),!a.isLeafNode())return i;let o=a.getValue();return typeof o==`number`?o+i:i},cc=function(e,t,n,r){return uc(t,new rc(n,e),r)},lc=function(e,t,n){return uc(e,new nc(t),n)};function uc(e,t,n){let r=ac(e.getPriority().val(),t.getImmediateChild(`.priority`),n),i;if(e.isLeafNode()){let i=e,a=ac(i.getValue(),t,n);return a!==i.getValue()||r!==i.getPriority().val()?new ta(a,U(r)):e}else{let a=e;return i=a,r!==a.getPriority().val()&&(i=i.updatePriority(new ta(r))),a.forEachChild(V,(e,r)=>{let a=uc(r,t.getImmediateChild(e),n);a!==r&&(i=i.updateImmediateChild(e,a))}),i}}var dc=class{constructor(e=``,t=null,n={children:{},childCount:0}){this.name=e,this.parent=t,this.node=n}};function fc(e,t){let n=t instanceof O?t:new O(t),r=e,i=A(n);for(;i!==null;){let e=je(r.node.children,i)||{children:{},childCount:0};r=new dc(i,r,e),n=M(n),i=A(n)}return r}function pc(e){return e.node.value}function mc(e,t){e.node.value=t,xc(e)}function hc(e){return e.node.childCount>0}function gc(e){return pc(e)===void 0&&!hc(e)}function _c(e,t){E(e.node.children,(n,r)=>{t(new dc(n,e,r))})}function vc(e,t,n,r){n&&!r&&t(e),_c(e,e=>{vc(e,t,!0,r)}),n&&r&&t(e)}function yc(e,t,n){let r=n?e:e.parent;for(;r!==null;){if(t(r))return!0;r=r.parent}return!1}function bc(e){return new O(e.parent===null?e.name:bc(e.parent)+`/`+e.name)}function xc(e){e.parent!==null&&Sc(e.parent,e.name,e)}function Sc(e,t,n){let r=gc(n),i=g(e.node.children,t);r&&i?(delete e.node.children[t],e.node.childCount--,xc(e)):!r&&!i&&(e.node.children[t]=n.node,e.node.childCount++,xc(e))}var Cc=/[\[\].#$\/\u0000-\u001F\u007F]/,wc=/[\[\].#$\u0000-\u001F\u007F]/,Tc=10*1024*1024,Ec=function(e){return typeof e==`string`&&e.length!==0&&!Cc.test(e)},Dc=function(e){return typeof e==`string`&&e.length!==0&&!wc.test(e)},Oc=function(e){return e&&=e.replace(/^\/*\.info(\/|$)/,`/`),Dc(e)},kc=function(e){return e===null||typeof e==`string`||typeof e==`number`&&!Jn(e)||e&&typeof e==`object`&&g(e,`.sv`)},Ac=function(e,t,n,r){r&&t===void 0||jc(Re(e,`value`),t,n)},jc=function(e,t,n){let r=n instanceof O?new ki(n,e):n;if(t===void 0)throw Error(e+`contains undefined `+L(r));if(typeof t==`function`)throw Error(e+`contains a function `+L(r)+` with contents = `+t.toString());if(Jn(t))throw Error(e+`contains `+t.toString()+` `+L(r));if(typeof t==`string`&&t.length>Tc/3&&Be(t)>Tc)throw Error(e+`contains a string greater than 10485760 utf8 bytes `+L(r)+` ('`+t.substring(0,50)+`...')`);if(t&&typeof t==`object`){let n=!1,i=!1;if(E(t,(t,a)=>{if(t===`.value`)n=!0;else if(t!==`.priority`&&t!==`.sv`&&(i=!0,!Ec(t)))throw Error(e+` contains an invalid key (`+t+`) `+L(r)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);Ai(r,t),jc(e,a,r),ji(r)}),n&&i)throw Error(e+` contains ".value" child `+L(r)+` in addition to actual children.`)}},Mc=function(e,t){let n,r;for(n=0;n<t.length;n++){r=t[n];let i=Ti(r);for(let t=0;t<i.length;t++)if(!(i[t]===`.priority`&&t===i.length-1)&&!Ec(i[t]))throw Error(e+`contains an invalid key (`+i[t]+`) in path `+r.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}t.sort(Di);let i=null;for(n=0;n<t.length;n++){if(r=t[n],i!==null&&I(i,r))throw Error(e+`contains a path `+i.toString()+` that is ancestor of another path `+r.toString());i=r}},Nc=function(e,t,n,r){if(r&&t===void 0)return;let i=Re(e,`values`);if(!(t&&typeof t==`object`)||Array.isArray(t))throw Error(i+` must be an object containing the children to replace.`);let a=[];E(t,(e,t)=>{let r=new O(e);if(jc(i,t,N(n,r)),Ci(r)===`.priority`&&!kc(t))throw Error(i+`contains an invalid value for '`+r.toString()+`', which must be a valid Firebase priority (a string, finite number, server value, or null).`);a.push(r)}),Mc(i,a)},Pc=function(e,t,n,r){if(!(r&&n===void 0)&&!Dc(n))throw Error(Re(e,t)+`was an invalid path = "`+n+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},Fc=function(e,t,n,r){n&&=n.replace(/^\/*\.info(\/|$)/,`/`),Pc(e,t,n,r)},Ic=function(e,t){if(A(t)===`.info`)throw Error(e+` failed = Can't modify data under /.info/`)},Lc=function(e,t){let n=t.path.toString();if(typeof t.repoInfo.host!=`string`||t.repoInfo.host.length===0||!Ec(t.repoInfo.namespace)&&t.repoInfo.host.split(`:`)[0]!==`localhost`||n.length!==0&&!Oc(n))throw Error(Re(e,`url`)+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)},Rc=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function zc(e,t){let n=null;for(let r=0;r<t.length;r++){let i=t[r],a=i.getPath();n!==null&&!Oi(a,n.path)&&(e.eventLists_.push(n),n=null),n===null&&(n={events:[],path:a}),n.events.push(i)}n&&e.eventLists_.push(n)}function Bc(e,t,n){zc(e,n),Vc(e,e=>Oi(e,t))}function Q(e,t,n){zc(e,n),Vc(e,e=>I(e,t)||I(t,e))}function Vc(e,t){e.recursionDepth_++;let n=!0;for(let r=0;r<e.eventLists_.length;r++){let i=e.eventLists_[r];if(i){let a=i.path;t(a)?(Hc(e.eventLists_[r]),e.eventLists_[r]=null):n=!1}}n&&(e.eventLists_=[]),e.recursionDepth_--}function Hc(e){for(let t=0;t<e.events.length;t++){let n=e.events[t];if(n!==null){e.events[t]=null;let r=n.getEventRunner();Hn&&C(`event: `+n.toString()),dr(r)}}}var Uc=`repo_interrupt`,Wc=25,Gc=class{constructor(e,t,n,r){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=n,this.appCheckProvider_=r,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new Rc,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=ja(),this.transactionQueueTree_=new dc,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?`https://`:`http://`)+this.repoInfo_.host}};function Kc(e,t,n){if(e.stats_=Pr(e.repoInfo_),e.forceRestClient_||fr())e.server_=new ka(e.repoInfo_,(t,n,r,i)=>{Yc(e,t,n,r,i)},e.authTokenProvider_,e.appCheckProvider_),setTimeout(()=>Xc(e,!0),0);else{if(n!=null){if(typeof n!=`object`)throw Error(`Only objects are supported for option databaseAuthVariableOverride`);try{h(n)}catch(e){throw Error(`Invalid authOverride provided: `+e)}}e.persistentConnection_=new Vi(e.repoInfo_,t,(t,n,r,i)=>{Yc(e,t,n,r,i)},t=>{Xc(e,t)},t=>{Zc(e,t)},e.authTokenProvider_,e.appCheckProvider_,n),e.server_=e.persistentConnection_}e.authTokenProvider_.addTokenChangeListener(t=>{e.server_.refreshAuthToken(t)}),e.appCheckProvider_.addTokenChangeListener(t=>{e.server_.refreshAppCheckToken(t.token)}),e.statsReporter_=Fr(e.repoInfo_,()=>new za(e.stats_,e.server_)),e.infoData_=new Aa,e.infoSyncTree_=new ks({startListening:(t,n,r,i)=>{let a=[],o=e.infoData_.getNode(t._path);return o.isEmpty()||(a=Ms(e.infoSyncTree_,t._path,o),setTimeout(()=>{i(`ok`)},0)),a},stopListening:()=>{}}),Qc(e,`connected`,!1),e.serverSyncTree_=new ks({startListening:(t,n,r,i)=>(e.server_.listen(t,r,n,(n,r)=>{let a=i(n,r);Q(e.eventQueue_,t._path,a)}),[]),stopListening:(t,n)=>{e.server_.unlisten(t,n)}})}function qc(e){let t=e.infoData_.getNode(new O(`.info/serverTimeOffset`)).val()||0;return new Date().getTime()+t}function Jc(e){return ic({timestamp:qc(e)})}function Yc(e,t,n,r,i){e.dataUpdateCount++;let a=new O(t);n=e.interceptServerDataCallback_?e.interceptServerDataCallback_(t,n):n;let o=[];if(i)if(r){let t=Ne(n,e=>U(e));o=Rs(e.serverSyncTree_,a,t,i)}else{let t=U(n);o=Ls(e.serverSyncTree_,a,t,i)}else if(r){let t=Ne(n,e=>U(e));o=Ns(e.serverSyncTree_,a,t)}else{let t=U(n);o=Ms(e.serverSyncTree_,a,t)}let s=a;o.length>0&&(s=fl(e,a)),Q(e.eventQueue_,s,o)}function Xc(e,t){Qc(e,`connected`,t),t===!1&&rl(e)}function Zc(e,t){E(t,(t,n)=>{Qc(e,t,n)})}function Qc(e,t,n){let r=new O(`/.info/`+t),i=U(n);e.infoData_.updateSnapshot(r,i);let a=Ms(e.infoSyncTree_,r,i);Q(e.eventQueue_,r,a)}function $c(e){return e.nextWriteId_++}function el(e,t,n){let r=Vs(e.serverSyncTree_,t);return r==null?e.server_.get(t).then(r=>{let i=U(r).withIndex(t._queryParams.getIndex());zs(e.serverSyncTree_,t,n,!0);let a;if(t._queryParams.loadsAllData())a=Ms(e.serverSyncTree_,t._path,i);else{let n=Ks(e.serverSyncTree_,t);a=Ls(e.serverSyncTree_,t._path,i,n)}return Q(e.eventQueue_,t._path,a),Is(e.serverSyncTree_,t,n,null,!0),i},n=>(sl(e,`get for query `+h(t)+` failed: `+n),Promise.reject(Error(n)))):Promise.resolve(r)}function tl(e,t,n,r,i){sl(e,`set`,{path:t.toString(),value:n,priority:r});let a=Jc(e),o=U(n,r),s=lc(o,Bs(e.serverSyncTree_,t),a),c=$c(e),l=As(e.serverSyncTree_,t,s,c,!0);zc(e.eventQueue_,l),e.server_.put(t.toString(),o.val(!0),(n,r)=>{let a=n===`ok`;a||T(`set at `+t+` failed: `+n);let o=Z(e.serverSyncTree_,c,!a);Q(e.eventQueue_,t,o),cl(e,i,n,r)});let u=vl(e,t);fl(e,u),Q(e.eventQueue_,u,[])}function nl(e,t,n,r){sl(e,`update`,{path:t.toString(),value:n});let i=!0,a=Jc(e),o={};if(E(n,(n,r)=>{i=!1,o[n]=cc(N(t,n),U(r),e.serverSyncTree_,a)}),i)C(`update() called with empty data.  Don't do anything.`),cl(e,r,`ok`,void 0);else{let i=$c(e),a=js(e.serverSyncTree_,t,o,i);zc(e.eventQueue_,a),e.server_.merge(t.toString(),n,(n,a)=>{let o=n===`ok`;o||T(`update at `+t+` failed: `+n);let s=Z(e.serverSyncTree_,i,!o),c=s.length>0?fl(e,t):t;Q(e.eventQueue_,c,s),cl(e,r,n,a)}),E(n,n=>{fl(e,vl(e,N(t,n)))}),Q(e.eventQueue_,t,[])}}function rl(e){sl(e,`onDisconnectEvents`);let t=Jc(e),n=ja();Na(e.onDisconnect_,k(),(r,i)=>{Ma(n,r,cc(r,i,e.serverSyncTree_,t))});let r=[];Na(n,k(),(t,n)=>{r=r.concat(Ms(e.serverSyncTree_,t,n)),fl(e,vl(e,t))}),e.onDisconnect_=ja(),Q(e.eventQueue_,k(),r)}function il(e,t,n){let r;r=A(t._path)===`.info`?zs(e.infoSyncTree_,t,n):zs(e.serverSyncTree_,t,n),Bc(e.eventQueue_,t._path,r)}function al(e,t,n){let r;r=A(t._path)===`.info`?Is(e.infoSyncTree_,t,n):Is(e.serverSyncTree_,t,n),Bc(e.eventQueue_,t._path,r)}function ol(e){e.persistentConnection_&&e.persistentConnection_.interrupt(Uc)}function sl(e,...t){let n=``;e.persistentConnection_&&(n=e.persistentConnection_.id+`:`),C(n,...t)}function cl(e,t,n,r){t&&dr(()=>{if(n===`ok`)t(null);else{let e=(n||`error`).toUpperCase(),i=e;r&&(i+=`: `+r);let a=Error(i);a.code=e,t(a)}})}function ll(e,t,n){return Bs(e.serverSyncTree_,t,n)||H.EMPTY_NODE}function ul(e,t=e.transactionQueueTree_){if(t||_l(e,t),pc(t)){let r=hl(e,t);n(r.length>0,`Sending zero length transaction queue`),r.every(e=>e.status===0)&&dl(e,bc(t),r)}else hc(t)&&_c(t,t=>{ul(e,t)})}function dl(e,t,r){let i=ll(e,t,r.map(e=>e.currentWriteId)),a=i,o=i.hash();for(let e=0;e<r.length;e++){let i=r[e];n(i.status===0,`tryToSendTransactionQueue_: items in queue should all be run.`),i.status=1,i.retryCount++;let o=F(t,i.path);a=a.updateChild(o,i.currentOutputSnapshotRaw)}let s=a.val(!0),c=t;e.server_.put(c.toString(),s,n=>{sl(e,`transaction put response`,{path:c.toString(),status:n});let i=[];if(n===`ok`){let n=[];for(let t=0;t<r.length;t++)r[t].status=2,i=i.concat(Z(e.serverSyncTree_,r[t].currentWriteId)),r[t].onComplete&&n.push(()=>r[t].onComplete(null,!0,r[t].currentOutputSnapshotResolved)),r[t].unwatcher();_l(e,fc(e.transactionQueueTree_,t)),ul(e,e.transactionQueueTree_),Q(e.eventQueue_,t,i);for(let e=0;e<n.length;e++)dr(n[e])}else{if(n===`datastale`)for(let e=0;e<r.length;e++)r[e].status===3?r[e].status=4:r[e].status=0;else{T(`transaction at `+c.toString()+` failed: `+n);for(let e=0;e<r.length;e++)r[e].status=4,r[e].abortReason=n}fl(e,t)}},o)}function fl(e,t){let n=ml(e,t),r=bc(n);return pl(e,hl(e,n),r),r}function pl(e,t,r){if(t.length===0)return;let i=[],a=[],o=t.filter(e=>e.status===0).map(e=>e.currentWriteId);for(let s=0;s<t.length;s++){let c=t[s],l=F(r,c.path),u=!1,d;if(n(l!==null,`rerunTransactionsUnderNode_: relativePath should not be null.`),c.status===4)u=!0,d=c.abortReason,a=a.concat(Z(e.serverSyncTree_,c.currentWriteId,!0));else if(c.status===0)if(c.retryCount>=Wc)u=!0,d=`maxretry`,a=a.concat(Z(e.serverSyncTree_,c.currentWriteId,!0));else{let n=ll(e,c.path,o);c.currentInputSnapshot=n;let r=t[s].update(n.val());if(r!==void 0){jc(`transaction failed: Data returned `,r,c.path);let t=U(r);typeof r==`object`&&r&&g(r,`.priority`)||(t=t.updatePriority(n.getPriority()));let i=c.currentWriteId,s=Jc(e),l=lc(t,n,s);c.currentOutputSnapshotRaw=t,c.currentOutputSnapshotResolved=l,c.currentWriteId=$c(e),o.splice(o.indexOf(i),1),a=a.concat(As(e.serverSyncTree_,c.path,l,c.currentWriteId,c.applyLocally)),a=a.concat(Z(e.serverSyncTree_,i,!0))}else u=!0,d=`nodata`,a=a.concat(Z(e.serverSyncTree_,c.currentWriteId,!0))}Q(e.eventQueue_,r,a),a=[],u&&(t[s].status=2,(function(e){setTimeout(e,0)})(t[s].unwatcher),t[s].onComplete&&(d===`nodata`?i.push(()=>t[s].onComplete(null,!1,t[s].currentInputSnapshot)):i.push(()=>t[s].onComplete(Error(d),!1,null))))}_l(e,e.transactionQueueTree_);for(let e=0;e<i.length;e++)dr(i[e]);ul(e,e.transactionQueueTree_)}function ml(e,t){let n,r=e.transactionQueueTree_;for(n=A(t);n!==null&&pc(r)===void 0;)r=fc(r,n),t=M(t),n=A(t);return r}function hl(e,t){let n=[];return gl(e,t,n),n.sort((e,t)=>e.order-t.order),n}function gl(e,t,n){let r=pc(t);if(r)for(let e=0;e<r.length;e++)n.push(r[e]);_c(t,t=>{gl(e,t,n)})}function _l(e,t){let n=pc(t);if(n){let e=0;for(let t=0;t<n.length;t++)n[t].status!==2&&(n[e]=n[t],e++);n.length=e,mc(t,n.length>0?n:void 0)}_c(t,t=>{_l(e,t)})}function vl(e,t){let n=bc(ml(e,t)),r=fc(e.transactionQueueTree_,t);return yc(r,t=>{yl(e,t)}),yl(e,r),vc(r,t=>{yl(e,t)}),n}function yl(e,t){let r=pc(t);if(r){let i=[],a=[],o=-1;for(let t=0;t<r.length;t++)r[t].status===3||(r[t].status===1?(n(o===t-1,`All SENT items should be at beginning of queue.`),o=t,r[t].status=3,r[t].abortReason=`set`):(n(r[t].status===0,`Unexpected transaction status in abort`),r[t].unwatcher(),a=a.concat(Z(e.serverSyncTree_,r[t].currentWriteId,!0)),r[t].onComplete&&i.push(r[t].onComplete.bind(null,Error(`set`),!1,null))));o===-1?mc(t,void 0):r.length=o+1,Q(e.eventQueue_,bc(t),a);for(let e=0;e<i.length;e++)dr(i[e])}}function bl(e){let t=``,n=e.split(`/`);for(let e=0;e<n.length;e++)if(n[e].length>0){let r=n[e];try{r=decodeURIComponent(r.replace(/\+/g,` `))}catch{}t+=`/`+r}return t}function xl(e){let t={};e.charAt(0)===`?`&&(e=e.substring(1));for(let n of e.split(`&`)){if(n.length===0)continue;let r=n.split(`=`);r.length===2?t[decodeURIComponent(r[0])]=decodeURIComponent(r[1]):T(`Invalid query segment '${n}' in query '${e}'`)}return t}var Sl=function(e,t){let n=Cl(e),r=n.namespace;n.domain===`firebase.com`&&w(n.host+` is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead`),(!r||r===`undefined`)&&n.domain!==`localhost`&&w(`Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com`),n.secure||qn();let i=n.scheme===`ws`||n.scheme===`wss`;return{repoInfo:new Or(n.host,n.secure,r,i,t,``,r!==n.subdomain),path:new O(n.pathString)}},Cl=function(e){let t=``,n=``,r=``,i=``,a=``,o=!0,s=`https`,c=443;if(typeof e==`string`){let l=e.indexOf(`//`);l>=0&&(s=e.substring(0,l-1),e=e.substring(l+2));let u=e.indexOf(`/`);u===-1&&(u=e.length);let d=e.indexOf(`?`);d===-1&&(d=e.length),t=e.substring(0,Math.min(u,d)),u<d&&(i=bl(e.substring(u,d)));let f=xl(e.substring(Math.min(e.length,d)));l=t.indexOf(`:`),l>=0?(o=s===`https`||s===`wss`,c=parseInt(t.substring(l+1),10)):l=t.length;let p=t.slice(0,l);if(p.toLowerCase()===`localhost`)n=`localhost`;else if(p.split(`.`).length<=2)n=p;else{let e=t.indexOf(`.`);r=t.substring(0,e).toLowerCase(),n=t.substring(e+1),a=r}`ns`in f&&(a=f.ns)}return{host:t,port:c,domain:n,subdomain:r,secure:o,scheme:s,pathString:i,namespace:a}},wl=`-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz`;(function(){let e=0,t=[];return function(r){let i=r===e;e=r;let a,o=Array(8);for(a=7;a>=0;a--)o[a]=wl.charAt(r%64),r=Math.floor(r/64);n(r===0,`Cannot push at time == 0`);let s=o.join(``);if(i){for(a=11;a>=0&&t[a]===63;a--)t[a]=0;t[a]++}else for(a=0;a<12;a++)t[a]=Math.floor(Math.random()*64);for(a=0;a<12;a++)s+=wl.charAt(t[a]);return n(s.length===20,`nextPushId: Length should be 20.`),s}})();var Tl=class{constructor(e,t,n,r){this.eventType=e,this.eventRegistration=t,this.snapshot=n,this.prevName=r}getPath(){let e=this.snapshot.ref;return this.eventType===`value`?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+`:`+this.eventType+`:`+h(this.snapshot.exportVal())}},El=class{constructor(e,t,n){this.eventRegistration=e,this.error=t,this.path=n}getPath(){return this.path}getEventType(){return`cancel`}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+`:cancel`}},Dl=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return n(this.hasCancelCallback,`Raising a cancel event on a listener with no cancel callback`),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}},Ol=class e{constructor(e,t,n,r){this._repo=e,this._path=t,this._queryParams=n,this._orderByCalled=r}get key(){return P(this._path)?null:Ci(this._path)}get ref(){return new $(this._repo,this._path)}get _queryIdentifier(){let e=tr(Oa(this._queryParams));return e===`{}`?`default`:e}get _queryObject(){return Oa(this._queryParams)}isEqual(t){if(t=Ve(t),!(t instanceof e))return!1;let n=this._repo===t._repo,r=Oi(this._path,t._path),i=this._queryIdentifier===t._queryIdentifier;return n&&r&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+wi(this._path)}},$=class e extends Ol{constructor(e,t){super(e,t,new Ta,!1)}get parent(){let t=Ei(this._path);return t===null?null:new e(this._repo,t)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},kl=class e{constructor(e,t,n){this._node=e,this.ref=t,this._index=n}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(t){let n=new O(t),r=jl(this.ref,t);return new e(this._node.getChild(n),r,V)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(t){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(n,r)=>t(new e(r,jl(this.ref,n),V)))}hasChild(e){let t=new O(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function Al(e,t){return e=Ve(e),e._checkNotDeleted(`ref`),t===void 0?e._root:jl(e._root,t)}function jl(e,t){return e=Ve(e),A(e._path)===null?Fc(`child`,`path`,t,!1):Pc(`child`,`path`,t,!1),new $(e._repo,N(e._path,t))}function Ml(e,t){e=Ve(e),Ic(`set`,e._path),Ac(`set`,t,e._path,!1);let n=new ce;return tl(e._repo,e._path,t,null,n.wrapCallback(()=>{})),n.promise}function Nl(e,t){Nc(`update`,t,e._path,!1);let n=new ce;return nl(e._repo,e._path,t,n.wrapCallback(()=>{})),n.promise}function Pl(e){e=Ve(e);let t=new Fl(new Dl(()=>{}));return el(e._repo,e,t).then(t=>new kl(t,new $(e._repo,e._path),e._queryParams.getIndex()))}var Fl=class e{constructor(e){this.callbackContext=e}respondsTo(e){return e===`value`}createEvent(e,t){let n=t._queryParams.getIndex();return new Tl(`value`,this,new kl(e.snapshotNode,new $(t._repo,t._path),n))}getEventRunner(e){return e.getEventType()===`cancel`?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new El(this,e,t):null}matches(t){return t instanceof e?!t.callbackContext||!this.callbackContext?!0:t.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},Il=class e{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e===`children_added`?`child_added`:e;return t=t===`children_removed`?`child_removed`:t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new El(this,e,t):null}createEvent(e,t){n(e.childName!=null,`Child events should have a childName.`);let r=jl(new $(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new Tl(e.type,this,new kl(e.snapshotNode,r,i),e.prevName)}getEventRunner(e){return e.getEventType()===`cancel`?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(t){return t instanceof e?this.eventType===t.eventType&&(!this.callbackContext||!t.callbackContext||this.callbackContext.matches(t.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function Ll(e,t,n,r,i){let a;if(typeof r==`object`&&(a=void 0,i=r),typeof r==`function`&&(a=r),i&&i.onlyOnce){let t=n,r=(n,r)=>{al(e._repo,e,s),t(n,r)};r.userCallback=n.userCallback,r.context=n.context,n=r}let o=new Dl(n,a||void 0),s=t===`value`?new Fl(o):new Il(t,o);return il(e._repo,e,s),()=>al(e._repo,e,s)}function Rl(e,t,n,r){return Ll(e,`value`,t,n,r)}ms($),Es($);var zl=`FIREBASE_DATABASE_EMULATOR_HOST`,Bl={},Vl=!1;function Hl(e,t,n,r){let i=t.lastIndexOf(`:`);e.repoInfo_=new Or(t,le(t.substring(0,i)),e.repoInfo_.namespace,e.repoInfo_.webSocketOnly,e.repoInfo_.nodeAdmin,e.repoInfo_.persistenceKey,e.repoInfo_.includeNamespaceInQueryParams,!0,n),r&&(e.authTokenProvider_=r)}function Ul(e,t,n,r,i){let a=r||e.options.databaseURL;a===void 0&&(e.options.projectId||w(`Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp().`),C(`Using default host for project `,e.options.projectId),a=`${e.options.projectId}-default-rtdb.firebaseio.com`);let o=Sl(a,i),s=o.repoInfo,c,l;typeof process<`u`&&(l={}[zl]),l?(c=!0,a=`http://${l}?ns=${s.namespace}`,o=Sl(a,i),s=o.repoInfo):c=!o.repoInfo.secure;let u=i&&c?new gr(gr.OWNER):new hr(e.name,e.options,t);return Lc(`Invalid Firebase Database URL`,o),P(o.path)||w(`Database URL must point to the root of a Firebase Database (not including a child path).`),new Kl(Gl(s,e,u,new mr(e,n)),e)}function Wl(e,t){let n=Bl[t];(!n||n[e.key]!==e)&&w(`Database ${t}(${e.repoInfo_}) has already been deleted.`),ol(e),delete n[e.key]}function Gl(e,t,n,r){let i=Bl[t.name];i||(i={},Bl[t.name]=i);let a=i[e.toURLString()];return a&&w(`Database initialized multiple times. Please make sure the format of the database URL matches with each database() call.`),a=new Gc(e,Vl,n,r),i[e.toURLString()]=a,a}var Kl=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type=`database`,this._instanceStarted=!1}get _repo(){return this._instanceStarted||=(Kc(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),!0),this._repoInternal}get _root(){return this._rootInternal||=new $(this._repo,k()),this._rootInternal}_delete(){return this._rootInternal!==null&&(Wl(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&w(`Cannot call `+e+` on a deleted database.`)}};function ql(e=dn(),t){let n=on(e,`database`).getImmediate({identifier:t});if(!n._instanceStarted){let e=oe(`database`);e&&Jl(n,...e)}return n}function Jl(e,t,n,r={}){e=Ve(e),e._checkNotDeleted(`useEmulator`);let i=`${t}:${n}`,a=e._repoInternal;if(e._instanceStarted){if(i===e._repoInternal.repoInfo_.host&&Pe(r,a.repoInfo_.emulatorOptions))return;w(`connectDatabaseEmulator() cannot initialize or alter the emulator configuration after the database instance has started.`)}let o;a.repoInfo_.nodeAdmin?(r.mockUserToken&&w(`mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".`),o=new gr(gr.OWNER)):r.mockUserToken&&(o=new gr(typeof r.mockUserToken==`string`?r.mockUserToken:de(r.mockUserToken,e.app.options.projectId))),le(t)&&(ue(t),ge(`Database`,!0)),Hl(a,i,r,o)}function Yl(e){Nn(ln),an(new He(`database`,(e,{instanceIdentifier:t})=>Ul(e.getProvider(`app`).getImmediate(),e.getProvider(`auth-internal`),e.getProvider(`app-check-internal`),t),`PUBLIC`).setMultipleInstances(!0)),fn(An,jn,e),fn(An,jn,`esm2020`)}Vi.prototype.simpleListen=function(e,t){this.sendRequest(`q`,{p:e},t)},Vi.prototype.echo=function(e,t){this.sendRequest(`echo`,{d:e},t)},Yl();export{Ml as a,Al as i,ql as n,Nl as o,Rl as r,un as s,Pl as t};